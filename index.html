<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bloom & Rest - Journaling</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* =========================================
           STYLE & THEME
           ========================================= */
        :root {
            --text-main: #2D3436;
            --text-light: #636E72;
            --primary-dark: #8E7CC3;
            --card-bg: rgba(255, 255, 255, 0.85);
            --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.05);
            --radius-lg: 24px;
            --radius-md: 16px;
            
            /* Mood Colors */
            --mood-happy: #FFEAA7; --mood-calm: #55EFC4; --mood-neutral: #DFE6E9; 
            --mood-sad: #74B9FF; --mood-heavy: #A29BFE; --mood-angry: #FF7675; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #FDFBF7;
            color: var(--text-main);
            /* FIX MOBILE: Kunci background biar ga gerak pas scroll */
            background-attachment: fixed;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            transition: background 0.5s ease, color 0.3s ease;
            display: flex;
            justify-content: center; 
        }

        /* --- GLOBAL BACKGROUND LAYER --- */
        #global-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -5;
            background: #FDFBF7;
            transition: background 0.8s ease;
        }
        /* MODE: HOME (Lover Theme - Pink/Purple Pastel) */
        #global-bg.bg-home { 
            background: linear-gradient(180deg, #E0C3FC 0%, #FFC3A0 100%);
        }
        /* MODE: MORNING (Bloom) */
        #global-bg.bg-bloom { background: linear-gradient(180deg, #89f7fe 0%, #66a6ff 100%); }
        /* MODE: NIGHT (Rest) */
        #global-bg.bg-rest { background: linear-gradient(180deg, #0f2027 0%, #203a43 50%, #2c5364 100%); }
        /* MODE: JOURNAL (Green Hills) */
        #global-bg.bg-journal { background: linear-gradient(180deg, #E0F7FA 0%, #B2EBF2 50%, #80DEEA 100%); }
        /* MODE: PLANNER (Elegant Sunset) */
        #global-bg.bg-planner {
            background: linear-gradient(180deg, #6C5B7B 0%, #C06C84 50%, #F8B195 100%);
        }
        /* MODE: SETTINGS (Morning Wind) - NEW! */
        #global-bg.bg-settings {
            background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%);
        }

        /* --- DECORATIONS --- */
        .decoration-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -4; pointer-events: none; opacity: 0; transition: opacity 0.6s; }
        .decoration-layer.active { opacity: 1; }
        
        /* DECO: HOME (Maple Leaves & Hearts) */
        .maple {
            position: absolute; font-size: 1.5rem; opacity: 0;
            animation: fallRotate 8s linear infinite;
            color: #D84315; /* Maple color */
        }
        .maple:nth-child(1) { left: 10%; animation-delay: 0s; font-size: 1.2rem; }
        .maple:nth-child(2) { left: 30%; animation-delay: 2s; font-size: 1.8rem; color: #FF7043; }
        .maple:nth-child(3) { left: 70%; animation-delay: 4s; font-size: 1.4rem; }
        .maple:nth-child(4) { left: 50%; animation-delay: 1s; font-size: 1.6rem; color: #FF8A65; }
        .maple:nth-child(5) { left: 90%; animation-delay: 3s; font-size: 1.3rem; }

        .float-heart {
            position: absolute; color: rgba(255, 255, 255, 0.4); font-size: 2rem;
            animation: floatUp 15s linear infinite;
        }
        .float-heart:nth-child(6) { left: 20%; bottom: -50px; animation-delay: 0s; }
        .float-heart:nth-child(7) { left: 80%; bottom: -50px; animation-delay: 5s; font-size: 1.5rem; }

        @keyframes fallRotate {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 0; }
            20% { opacity: 0.5; }
            100% { transform: translateY(-100vh); opacity: 0; }
        }

        /* DECO: BLOOM/PLANNER (Clouds) */
        .cloud { position: absolute; background: rgba(255,255,255,0.7); border-radius: 50px; animation: moveCloud linear infinite; }
        .cloud::after, .cloud::before { content:''; position: absolute; background: inherit; border-radius: 50%; }
        .cloud::after { width: 50%; height: 150%; top: -60%; left: 15%; }
        .cloud::before { width: 40%; height: 120%; top: -45%; right: 15%; }
        @keyframes moveCloud { from { transform: translateX(-100%); } to { transform: translateX(100vw); } }

        /* DECO: SETTINGS (Wind Lines) - NEW! */
        .wind {
            position: absolute;
            height: 2px;
            background: rgba(255,255,255,0.6);
            border-radius: 4px;
            animation: windBlow 4s linear infinite;
            opacity: 0;
        }
        .wind:nth-child(1) { top: 20%; left: -20%; width: 100px; animation-duration: 5s; }
        .wind:nth-child(2) { top: 40%; left: -10%; width: 150px; animation-duration: 4s; animation-delay: 1s; }
        .wind:nth-child(3) { top: 60%; left: -30%; width: 80px; animation-duration: 6s; animation-delay: 0.5s; }
        .wind:nth-child(4) { top: 80%; left: -20%; width: 120px; animation-duration: 5.5s; animation-delay: 2s; }
        .wind:nth-child(5) { top: 10%; left: -25%; width: 60px; animation-duration: 7s; animation-delay: 1.5s; }

        @keyframes windBlow {
            0% { transform: translateX(0); opacity: 0; }
            10% { opacity: 0.8; }
            80% { opacity: 0.8; }
            100% { transform: translateX(120vw); opacity: 0; }
        }

        /* DECO: REST (Stars) */
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle infinite ease-in-out; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        /* DECO: JOURNAL (Falling Leaves & Hills) */
        .leaf {
            position: absolute; width: 15px; height: 15px; background: #81C784; border-radius: 0 10px 3px 10px; opacity: 0;
            animation: fallingLeaf 8s linear infinite;
            z-index: 1;
        }
        .leaf:nth-child(1) { left: 10%; animation-delay: 0s; }
        .leaf:nth-child(2) { left: 30%; animation-delay: 2s; width: 10px; height: 10px; }
        .leaf:nth-child(3) { left: 70%; animation-delay: 4s; }
        .leaf:nth-child(4) { left: 50%; animation-delay: 1s; width: 12px; height: 12px; }
        .leaf:nth-child(5) { left: 90%; animation-delay: 3s; }
        @keyframes fallingLeaf {
            0% { transform: translate(0, -20px) rotate(0deg); opacity: 0; } 10% { opacity: 0.7; } 100% { transform: translate(50px, 100vh) rotate(360deg); opacity: 0; }
        }

        .hills {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 30%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23A5D6A7" fill-opacity="1" d="M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,224C672,245,768,267,864,261.3C960,256,1056,224,1152,197.3C1248,171,1344,149,1392,138.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-size: cover; background-repeat: no-repeat; z-index: 0;
        }
        .hills-back {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 45%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23C8E6C9" fill-opacity="1" d="M0,96L48,112C96,128,192,160,288,186.7C384,213,480,235,576,213.3C672,192,768,128,864,128C960,128,1056,192,1152,208C1248,224,1344,192,1392,176L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-size: cover; background-repeat: no-repeat; opacity: 0.8; z-index: -1;
        }

        /* --- APP CONTAINER --- */
        #app {
            width: 100%; max-width: 480px; min-height: 100vh;
            padding-bottom: 90px;
            display: flex; flex-direction: column;
            position: relative; z-index: 1;
            text-align: center;
        }
        
        /* --- COMPONENTS --- */
        .card {
            background: var(--card-bg); 
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: var(--radius-lg);
            padding: 1.5rem; margin-bottom: 1.5rem; 
            box-shadow: var(--shadow-soft);
            color: var(--text-main) !important;
            text-align: left;
        }
        .card.centered { text-align: center; }

        h1, h2, h3 { font-weight: 700; margin-bottom: 0.5rem; text-align: center; }
        p { line-height: 1.6; font-size: 0.95rem; }
        .text-light { color: var(--text-light); font-size: 0.85rem; }
        .text-xs { font-size: 0.75rem; color: var(--text-light); }

        /* HEADER & GREETING CENTERED */
        #view-home .header-section {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding-top: 2rem; margin-bottom: 1rem; text-align: center;
        }

        .btn {
            border: none; padding: 12px 24px; border-radius: 50px; cursor: pointer;
            font-family: inherit; font-weight: 600; width: 100%; display: flex;
            align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        .btn-primary { background: var(--primary-dark); color: white !important; box-shadow: 0 4px 15px rgba(142, 124, 195, 0.4); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-outline { border: 2px solid var(--primary-dark); background: transparent; color: var(--text-main); }
        .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 50%; background: rgba(255,255,255,0.3); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }

        input, textarea {
            width: 100%; padding: 14px; border: 2px solid rgba(0,0,0,0.05); border-radius: var(--radius-md);
            margin-bottom: 1rem; outline: none; background: rgba(255,255,255,0.6);
            font-family: inherit; font-size: 1rem; color: var(--text-main) !important;
        }
        input:focus, textarea:focus { border-color: var(--primary-dark); background: white; }

        /* --- VIEW TRANSITIONS --- */
        .view { display: none; padding: 20px; animation: fadeIn 0.5s ease forwards; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 440px; background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px); border-radius: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; padding: 12px 20px; z-index: 100;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: var(--text-light); cursor: pointer; transition: 0.3s; }
        .nav-item i { font-size: 1.6rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary-dark); font-weight: 600; }
        .nav-item.active i { transform: translateY(-3px); }

        /* --- COMPONENTS --- */
        .mood-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 1.5rem; }
        .mood-option { background: rgba(255,255,255,0.5); padding: 15px 5px; border-radius: var(--radius-md); text-align: center; cursor: pointer; transition: 0.3s; }
        .mood-option.selected { border: 2px solid var(--primary-dark); background: white; transform: translateY(-3px); }
        .mood-emoji { font-size: 2rem; display: block; margin-bottom: 5px; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 10px; }
        .day-name { font-size: 0.8rem; text-align: center; color: var(--text-light); font-weight: 600; }
        /* Calendar Day Updated Layout */
        .calendar-day { 
            aspect-ratio: 1; border-radius: 12px; 
            display: flex; flex-direction: column; /* Stack date and icon */
            align-items: center; justify-content: center; gap: 2px;
            background: rgba(255,255,255,0.5); cursor: pointer; 
            font-size: 0.9rem; font-weight: 600; color: var(--text-main); 
        }
        .day-today { border: 2px solid var(--text-main); }
        /* Calendar Mood Colors */
        .day-happy { background-color: var(--mood-happy); } .day-calm { background-color: var(--mood-calm); }
        .day-neutral { background-color: var(--mood-neutral); } .day-sad { background-color: var(--mood-sad); }
        .day-heavy { background-color: var(--mood-heavy); } .day-angry { background-color: var(--mood-angry); }

        /* Overlay */
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95);
            z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center; opacity: 0; pointer-events: none; transition: 0.5s;
            color: var(--text-main) !important;
        }
        .overlay.show { opacity: 1; pointer-events: all; }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        /* Pat Pat Animation */
        @keyframes patpat {
            0% { transform: rotate(0deg) translateY(0); }
            25% { transform: rotate(-10deg) translateY(-10px); }
            50% { transform: rotate(0deg) translateY(0); }
            75% { transform: rotate(10deg) translateY(-10px); }
            100% { transform: rotate(0deg) translateY(0); }
        }
        .pat-animation { animation: patpat 1s ease-in-out infinite; }

        /* Task & Reveal Items */
        .task-item { display: flex; align-items: center; background: rgba(255,255,255,0.6); padding: 12px; border-radius: 12px; margin-bottom: 8px; color: var(--text-main); }
        .task-check { min-width: 22px; height: 22px; border: 2px solid var(--primary-dark); border-radius: 6px; margin-right: 12px; display: grid; place-items: center; }
        .task-check.checked { background: var(--primary-dark); }
        .task-check.checked::after { content: '‚úî'; color: white; font-size: 12px; }
        .task-text.done { text-decoration: line-through; opacity: 0.5; }
        .reveal-card:hover i { animation: shake 0.5s ease-in-out infinite; }
        @keyframes shake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }

        /* Morning Summary Box */
        .morning-summary-box {
            background: linear-gradient(135deg, #fff 0%, #FFF3E0 100%);
            border: 1px solid #FFE0B2;
            padding: 1rem; border-radius: 12px; margin-bottom: 1rem; text-align: left;
        }
        .morning-item { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
        .morning-dot { width: 8px; height: 8px; background: #FFB74D; border-radius: 50%; flex-shrink: 0; }

        /* Dark Mode Text Fix */
        body.dark-theme h1, body.dark-theme h2, body.dark-theme .btn-icon { color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        /* Planner Specifics (UPDATED BUTTON) */
        .category-group {
            background: rgba(255,255,255,0.4);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .add-task-wrapper {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        .add-task-wrapper input {
            margin-bottom: 0;
            font-size: 0.9rem;
            padding: 10px;
            flex: 1;
        }
        /* Style baru untuk tombol tambah tugas supaya ga nabrak */
        .add-task-wrapper button {
            flex-shrink: 0;
            background-color: var(--primary-dark); 
            color: white !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .add-task-wrapper button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }

    </style>
</head>
<body>

<!-- GLOBAL BACKGROUND LAYER -->
<div id="global-bg" class="bg-home"></div>

<!-- DECORATIONS LAYER -->
<div id="deco-home" class="decoration-layer active">
    <div class="maple">üçÇ</div>
    <div class="maple">üçÇ</div>
    <div class="maple">üçÇ</div>
    <div class="maple">üçÇ</div>
    <div class="maple">üçÇ</div>
    <div class="float-heart">üíñ</div>
    <div class="float-heart">ü§ç</div>
</div>

<div id="deco-bloom" class="decoration-layer">
    <div class="cloud" style="width: 120px; height: 40px; top: 10%; left: -20%; animation-duration: 25s;"></div>
    <div class="cloud" style="width: 100px; height: 35px; top: 25%; left: -10%; animation-duration: 35s; opacity: 0.7;"></div>
    <div class="cloud" style="width: 140px; height: 45px; top: 60%; left: -25%; animation-duration: 30s; opacity: 0.8;"></div>
</div>

<div id="deco-rest" class="decoration-layer">
    <div class="star" style="width: 3px; height: 3px; top: 10%; left: 20%; animation-delay: 0s;"></div>
    <div class="star" style="width: 4px; height: 4px; top: 20%; left: 80%; animation-delay: 1s;"></div>
    <div class="star" style="width: 2px; height: 2px; top: 35%; left: 40%; animation-delay: 2s;"></div>
    <div class="star" style="width: 3px; height: 3px; top: 50%; left: 10%; animation-delay: 1.5s;"></div>
    <div class="star" style="width: 4px; height: 4px; top: 65%; left: 85%; animation-delay: 0.5s;"></div>
</div>

<!-- NEW DECORATION: JOURNAL (Falling Leaves & Hills) -->
<div id="deco-journal" class="decoration-layer">
    <div class="leaf"></div>
    <div class="leaf"></div>
    <div class="leaf"></div>
    <div class="leaf"></div>
    <div class="leaf"></div>
    <div class="hills"></div>
    <div class="hills-back"></div>
</div>

<!-- NEW DECORATION: PLANNER (Sunset Clouds) -->
<div id="deco-planner" class="decoration-layer">
    <div class="cloud" style="width: 130px; height: 45px; top: 15%; left: -20%; animation-duration: 35s; opacity: 0.6;"></div>
    <div class="cloud" style="width: 90px; height: 30px; top: 35%; left: -10%; animation-duration: 45s; opacity: 0.5;"></div>
    <div class="cloud" style="width: 150px; height: 50px; top: 55%; left: -25%; animation-duration: 30s; opacity: 0.4;"></div>
</div>

<!-- NEW DECORATION: SETTINGS (Wind) -->
<div id="deco-settings" class="decoration-layer">
    <div class="wind"></div>
    <div class="wind"></div>
    <div class="wind"></div>
    <div class="wind"></div>
    <div class="wind"></div>
</div>

<div id="app">
    
    <!-- ================= VIEW: HOME ================= -->
    <div id="view-home" class="view active">
        <!-- Header Centered -->
        <div class="header-section">
            <h1 id="greeting">Halo, Kamu.</h1>
            <p class="text-light" id="current-date-display">Jumat, 2 Januari 2026</p>
            <div style="background: white; padding: 10px; border-radius: 50%; box-shadow: var(--shadow-soft); display: inline-flex; margin-top: 10px;">
                <i class="ph-fill ph-plant" style="font-size: 2rem; color: var(--primary-dark);"></i>
            </div>
        </div>

        <div>
            <!-- Lyric of the day -->
            <div class="card centered" style="position: relative; overflow: hidden;">
                <i class="ph-fill ph-spotify-logo" style="font-size: 3rem; color: #1DB954; position: absolute; top: -10px; left: 10px; opacity: 0.2;"></i>
                <p id="daily-lyric-text" style="font-style: italic; font-weight: 500; font-size: 1.1rem; margin-top: 10px; margin-bottom: 5px;">"..."</p>
                <p id="daily-lyric-source" class="text-xs text-light">Song - Artist</p>
            </div>

            <!-- MORNING SUMMARY -->
            <div id="home-morning-summary" style="display: none;">
                <!-- Injected via JS -->
            </div>

            <!-- Mini Games Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 1.5rem;">
                <div class="card reveal-card centered" style="margin-bottom: 0; padding: 1rem;" onclick="BloomApp.fortune.open()">
                    <div id="cookie-closed">
                        <i class="ph-fill ph-cookie" style="font-size: 2.5rem; color: #D4A373;"></i>
                        <p style="font-size: 0.85rem; font-weight: 600; color: #D4A373; margin-top: 5px;">Fortune Cookie</p>
                    </div>
                    <div id="cookie-opened" style="display: none; animation: fadeIn 0.5s;">
                        <p class="text-xs text-light">Kata hari ini:</p>
                        <p id="fortune-text" style="font-size: 0.85rem; font-weight: 600; color: var(--primary-dark); margin: 5px 0;">"..."</p>
                        <button class="btn-outline btn-sm" style="border-radius: 20px; font-size: 0.7rem; padding: 4px 8px;" onclick="event.stopPropagation(); BloomApp.fortune.reset()">Tutup</button>
                    </div>
                </div>
                <div class="card reveal-card centered" style="margin-bottom: 0; padding: 1rem;" onclick="BloomApp.quran.open()">
                    <div id="quran-closed">
                        <i class="ph-fill ph-book-open-text" style="font-size: 2.5rem; color: #81C784;"></i>
                        <p style="font-size: 0.85rem; font-weight: 600; color: #81C784; margin-top: 5px;">Pesan Langit</p>
                    </div>
                    <div id="quran-opened" style="display: none; animation: fadeIn 0.5s;">
                        <p id="quran-text" style="font-size: 0.85rem; font-weight: 600; color: #2E7D32; margin: 5px 0;">"..."</p>
                        <p id="quran-surah" style="font-size: 0.7rem; color: #81C784; font-style: italic; margin-bottom: 5px;">QS...</p>
                        <button class="btn-outline btn-sm" style="border-radius: 20px; font-size: 0.7rem; padding: 4px 8px; border-color: #81C784; color: #2E7D32;" onclick="event.stopPropagation(); BloomApp.quran.reset()">Tutup</button>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="card centered" style="margin-bottom: 0; background: linear-gradient(135deg, #fff 0%, #FFF8E1 100%); cursor: pointer;" onclick="BloomApp.router.go('bloom')">
                    <i class="ph-fill ph-sun" style="font-size: 2rem; color: #FFB74D; margin-bottom: 10px;"></i>
                    <h3>Morning</h3>
                    <p class="text-light text-xs">Mulai hari dengan niat.</p>
                </div>
                <div class="card centered" style="margin-bottom: 0; background: linear-gradient(135deg, #fff 0%, #E3F2FD 100%); cursor: pointer;" onclick="BloomApp.router.go('rest')">
                    <i class="ph-fill ph-moon-stars" style="font-size: 2rem; color: #5C6BC0; margin-bottom: 10px;"></i>
                    <h3>Night</h3>
                    <p class="text-light text-xs">Tutup hari dengan tenang.</p>
                </div>
            </div>

            <div class="card" style="margin-top: 1.5rem;" onclick="BloomApp.router.go('planner')">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin:0;">üéØ Minggu Ini</h3>
                    <span class="text-light text-xs">Lihat Semua ></span>
                </div>
                <div id="home-tasks-preview" style="text-align: left;"></div>
            </div>
        </div>
    </div>

    <!-- ================= VIEW: BLOOM ================= -->
    <div id="view-bloom" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
            <h2 style="margin:0; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">‚òÄÔ∏è Morning Bloom</h2>
            <button class="btn-icon" onclick="BloomApp.router.go('home')"><i class="ph ph-x"></i></button>
        </div>
        <div class="card" style="padding: 0; overflow: hidden;">
            <div style="padding: 15px; background: rgba(255,255,255,0.5);">
                <h4 style="margin:0; display:flex; align-items:center; justify-content:center; gap:8px;"><i class="ph-fill ph-music-note"></i> Lagu Semangat Pagi</h4>
            </div>
            <iframe id="spotify-bloom" style="border-radius:0px 0px 12px 12px" src="" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
        </div>
        <div class="card centered">
            <h3 style="margin-bottom:15px;">Mood Check-in</h3>
            <div class="mood-selector" id="bloom-moods"></div>
        </div>
        <div class="card">
            <h3>Intention</h3>
            <input type="text" id="bloom-intention" placeholder="Hari ini aku ingin lebih...">
        </div>
        <div class="card">
            <h3>Tiny To-Do</h3>
            <div id="todo-container">
                <input type="text" class="todo-input" placeholder="1. Fokus utama...">
                <input type="text" class="todo-input" placeholder="2. ...">
                <input type="text" class="todo-input" placeholder="3. ...">
            </div>
        </div>
        <button class="btn btn-primary" onclick="BloomApp.bloom.save()">Simpan Bloom</button>
        <br><br><br>
    </div>

    <!-- ================= VIEW: REST ================= -->
    <div id="view-rest" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
            <h2 style="margin:0;">üåô Night Rest</h2>
            <button class="btn-icon" onclick="BloomApp.router.go('home')"><i class="ph ph-x"></i></button>
        </div>
        <div class="card" style="padding: 0; overflow: hidden;">
            <div style="padding: 15px; background: rgba(255,255,255,0.5);">
                <h4 style="margin:0; display:flex; align-items:center; justify-content:center; gap:8px;"><i class="ph-fill ph-moon"></i> Pengantar Tidur</h4>
            </div>
            <iframe id="spotify-rest" style="border-radius:0px 0px 12px 12px" src="" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
        </div>
        
        <!-- MORNING REVIEW -->
        <div class="card" id="night-review-section" style="display:none; background: #FFF3E0; border: 1px solid #FFE0B2;">
            <h3 style="color: #F57C00;">Review Niat Pagi</h3>
            
            <div id="review-intention-wrapper" style="display:none; margin-bottom:15px;">
                <p class="text-xs text-light" style="margin-bottom:5px; text-align: center;">Niatmu tadi pagi:</p>
                <p id="review-intention-text" style="font-weight:600; font-style:italic; text-align: center;">"..."</p>
            </div>

            <!-- TODO CHECKLIST CONTAINER -->
            <div id="night-review-todos" style="margin-top:10px;"></div>

            <div style="margin-top:15px; border-top:1px dashed #FFE0B2; padding-top:10px;">
                <p class="text-xs" style="text-align: center;">Catatan kecil untuk hari ini:</p>
                <input type="text" id="rest-review-note" placeholder="Ceritain dikit..." style="background:white;">
            </div>
        </div>

        <div class="card centered">
            <h3>Mood Closing</h3>
            <div class="mood-selector" id="rest-moods"></div>
        </div>
        <div class="card">
            <h3>Day Recap</h3>
            <textarea id="rest-recap" rows="3" placeholder="Ceritakan sedikit tentang harimu..."></textarea>
        </div>
        <div class="card">
            <h3>Refleksi</h3>
            <div style="margin-bottom: 10px;"><label class="text-xs">WIN OF THE DAY</label><input type="text" id="rest-ref1" placeholder="Apa yang berjalan baik?"></div>
            <div><label class="text-xs">LETTING GO</label><input type="text" id="rest-ref2" placeholder="Apa yang ingin dilepaskan?"></div>
        </div>
        <div class="card">
            <h3>1 Gratitude</h3>
            <input type="text" id="rest-gratitude" placeholder="Aku bersyukur karena...">
        </div>
        <button class="btn btn-primary" onclick="BloomApp.rest.saveAndStartFlow()">Selesai & Istirahat</button>
        <br><br><br>
    </div>

    <!-- ================= VIEW: PLANNER ================= -->
    <div id="view-planner" class="view">
        <h2>üìù Tugas Minggu Ini</h2>
        <div id="planner-container"></div>
        <button class="btn btn-outline" onclick="BloomApp.planner.addCategoryPrompt()">+ Tambah Kategori Baru</button>
        <br><br><br> 
    </div>

    <!-- ================= VIEW: CALENDAR ================= -->
    <div id="view-calendar" class="view">
        <h2>üìÖ Mood Calendar</h2>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <button class="btn-icon" style="background:var(--primary-soft)" onclick="BloomApp.calendar.prevMonth()">&lt;</button>
                <h3 id="cal-month-year" style="margin:0;">Januari 2026</h3>
                <button class="btn-icon" style="background:var(--primary-soft)" onclick="BloomApp.calendar.nextMonth()">&gt;</button>
            </div>
            <div class="calendar-grid">
                <div class="day-name">Min</div><div class="day-name">Sen</div><div class="day-name">Sel</div><div class="day-name">Rab</div><div class="day-name">Kam</div><div class="day-name">Jum</div><div class="day-name">Sab</div>
            </div>
            <div id="calendar-days" class="calendar-grid"></div>
        </div>
        <div id="day-detail-panel" class="card" style="display:none; animation: fadeIn 0.3s;">
            <h3 id="detail-date" style="color:var(--primary-dark)">Detail</h3>
            <div style="margin-top: 15px; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 12px;">
                <p class="text-xs">PAGI</p><p><strong>Mood:</strong> <span id="detail-bloom-mood">-</span></p><p class="text-light" id="detail-intention">-</p>
            </div>
            <div style="margin-top: 10px; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 12px;">
                <p class="text-xs">MALAM</p><p><strong>Mood:</strong> <span id="detail-rest-mood">-</span></p><p class="text-light" id="detail-recap">-</p><p class="text-light" style="margin-top:5px; color: var(--primary-dark); font-weight:600;">‚ú® <span id="detail-gratitude">-</span></p>
            </div>
        </div>
        <br><br><br>
    </div>

    <!-- ================= VIEW: SETTINGS ================= -->
    <div id="view-settings" class="view">
        <h2>‚öôÔ∏è Pengaturan</h2>
        <div class="card">
            <h3>üéµ Link Spotify</h3>
            <div style="margin-top: 15px;"><label class="text-xs">Lagu Pagi</label><input type="text" id="setting-spotify-bloom"></div>
            <div><label class="text-xs">Lagu Malam</label><input type="text" id="setting-spotify-rest"></div>
            <button class="btn btn-primary btn-sm" onclick="BloomApp.settings.saveSpotify()">Simpan Lagu</button>
        </div>
        <div class="card">
            <h3>Data</h3>
            <button class="btn btn-outline" style="color: #ff6b6b; border-color: #ff6b6b;" onclick="BloomApp.storage.clear()">Reset Semua Data</button>
        </div>
    </div>

    <!-- OVERLAY -->
    <div id="gratitude-overlay" class="overlay">
        <div id="overlay-content" style="width: 100%; max-width: 400px;">
            <i class="ph-fill ph-heart" id="overlay-icon" style="font-size: 4rem; color: var(--primary-dark); margin-bottom: 20px; animation: breathe 3s infinite;"></i>
            <h2 id="overlay-title" style="font-size: 2rem;">Title</h2>
            <p id="overlay-text" style="font-size: 1.3rem; margin-bottom: 40px; font-weight: 500;">"..."</p>
            <div id="overlay-actions"></div>
        </div>
    </div>

    <!-- NAVBAR -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="BloomApp.router.go('home')" data-target="home"><i class="ph ph-house"></i><span>Home</span></div>
        <div class="nav-item" onclick="BloomApp.router.go('planner')" data-target="planner"><i class="ph ph-list-checks"></i><span>Tugas</span></div>
        <div class="nav-item" onclick="BloomApp.router.go('calendar')" data-target="calendar"><i class="ph ph-calendar-heart"></i><span>Jurnal</span></div>
        <div class="nav-item" onclick="BloomApp.router.go('settings')" data-target="settings"><i class="ph ph-gear"></i><span>Settings</span></div>
    </div>

</div>

<script>
    /* ================= DATA & CONSTANTS ================= */
    const DATA = {
        lyrics: [
            // INDONESIA
            { text: "Tenangkan hati, semua ini bukan salahmu. Jangan berhenti yang kau takutkan takkan terjadi.", source: "Rehat - Kunto Aji" },
            { text: "Bernafaslah sejenak, lupakanlah beban di pundak.", source: "Rehat - Kunto Aji" },
            { text: "Yang patah tumbuh, yang hilang berganti.", source: "Yang Patah Tumbuh - Banda Neira" },
            { text: "Kita manusia, wajar jika tak sempurna. Saat kau jatuh, bangkitlah perlahan.", source: "Memulai Kembali - Monita Tahalea" },
            { text: "Luka-luka hilanglah lara. Kau berharga, kau berhak bahagia.", source: "Diri - Tulus" },
            { text: "Katakan pada dirimu: 'Terima kasih sudah bertahan hebat hingga kini'.", source: "Diri - Tulus" },
            { text: "Maafkan semua yang lalu, ampuni hati kecilmu.", source: "Diri - Tulus" },
            { text: "Kau bisa patahkan kakiku, tapi tidak mimpi-mimpiku. Kau manusia kuat.", source: "Manusia Kuat - Tulus" },
            { text: "Aku tak sempurna, tak perlu sempurna. Akan kurayakan apa adanya.", source: "Tutur Batin - Yura Yunita" },
            { text: "Kau terjatuh dan terjaga, kau sedih dan bahagia. Kau tetap indah.", source: "Tenang - Yura Yunita" },
            { text: "Perjalanan masih panjang, tak perlu tergesa-gesa. Masalah pelik percaya kan reda.", source: "Evaluasi - Hindia" },
            { text: "Apapun yang kau yakini, semoga itu yang kau dapati.", source: "Secukupnya - Hindia" },
            { text: "Untungnya bumi masih berputar, untungnya ku tak pilih menyerah.", source: "Untungnya - Bernadya" },
            { text: "Takut tambah dewasa, takut aku kecewa. Takut tak seindah yang kukira.", source: "Takut - Idgitaf" },
            { text: "Cukupkanlah, ikat rambutmu. Basuh wajahmu, dunia belum berakhir.", source: "Beranjak Dewasa - Nadin Amizah" },
            { text: "Langit dan laut saling membantu, membenih hujan, mengirim rindu.", source: "Sorai - Nadin Amizah" },
            { text: "Biar ku gendong pulang, kau mengantuk, biar ku gendong pulang.", source: "Ikat Aku di Tulang Belikatmu - Sal Priadi" },
            { text: "Bahagia itu sederhana, sesederhana kamu tersenyum dan bersyukur.", source: "Bahagia - GAC" },
            { text: "Dan lapangkan dadamu, untuk terima itu. Agar senang hatimu, agar tenang jiwamu.", source: "Lapang Dada - Sheila On 7" },
            { text: "Menarilah dan terus tertawa, walau dunia tak seindah surga.", source: "Laskar Pelangi - Nidji" },
            { text: "Tenang, tenang yang tak kunjung datang. Menanti-nanti cahaya-Mu, beri aku petunjuk-Mu.", source: "Tenang - Yura Yunita" },
            { text: "Kita adalah sepasang sepatu, selalu bersama tak bisa bersatu.", source: "Sepatu - Tulus" },
            { text: "Dunia tipu-tipu, kita bisa pura-pura gila.", source: "Dunia Tipu-Tipu - Yura Yunita" },
            { text: "Cukup tahu, ku tak mau tahu lagi.", source: "Cukup Tahu - Rizky Febian" },
            
            // WESTERN
            { text: "Lights will guide you home, and ignite your bones. And I will try to fix you.", source: "Fix You - Coldplay" },
            { text: "But I promise you this, I'll always look out for you.", source: "Sparks - Coldplay" },
            { text: "Just because you're losing, doesn't mean you're lost.", source: "Lost - Coldplay" },
            { text: "And you're gonna be happy. Turn this all around.", source: "Zero O'Clock - BTS" },
            { text: "You can't stop me lovin' myself.", source: "Idol - BTS" },
            { text: "Tak apa-apa jika kau kehabisan nafas, tidak ada yang menyalahkanmu.", source: "Breathe - Lee Hi" },
            { text: "It's okay not to be okay. It's okay not to be alright.", source: "OK Not To Be OK - Marshmello & Demi Lovato" },
            { text: "When you're down and out, remember everything will be okay.", source: "Be Alright - Dean Lewis" },
            { text: "There's a hope that's waiting for you in the dark.", source: "Scars to Your Beautiful - Alessia Cara" },
            { text: "You just gotta ignite the light, and let it shine.", source: "Firework - Katy Perry" },
            { text: "Here comes the sun, and I say, it's all right.", source: "Here Comes The Sun - The Beatles" },
            { text: "Don't stop believin', hold on to that feelin'.", source: "Don't Stop Believin' - Journey" },
            { text: "What doesn't kill you makes you stronger.", source: "Stronger - Kelly Clarkson" },
            { text: "I'm beautiful in my way 'cause God makes no mistakes.", source: "Born This Way - Lady Gaga" },
            { text: "And I know that I can make it through the rain.", source: "Through The Rain - Mariah Carey" },
            { text: "The sun goes down, the stars come out. And all that counts is here and now.", source: "Glad You Came - The Wanted" }
        ],
        gratitude_prompts: [
            "Terima kasih sudah bertahan hari ini.", "Capekmu valid, istirahatmu layak.", "Aku memaafkan diriku hari ini.", 
            "Tubuhku, terima kasih sudah kuat.", "Pikiran, terima kasih sudah bekerja keras.", "Aku bersyukur untuk hal-hal kecil.",
            "Terima kasih diriku, sudah mau mencoba lagi.", "Hari ini berat, tapi aku berhasil melewatinya.",
            "Aku bangga pada diriku sendiri.", "Terima kasih nafas, terima kasih detak jantung."
        ],
        prayers: [
            "Ya Tuhan, lindungilah tidurku.", "Bismika Allahumma ahya wa amut.", "Ya Allah, ampuni dosaku hari ini.", 
            "Tuhan, jika hari ini aku terluka, sembuhkanlah.", "Lindungi orang-orang yang kucintai.",
            "Ya Allah, jauhkanlah aku dari mimpi buruk.", "Tuhan, berikanlah aku istirahat yang berkualitas."
        ],
        morning_prayers: [
            "Ya Allah, mudahkanlah urusanku.", "Bismillahi tawakkaltu 'alallah.", "Tuhan, jadikan hari ini lebih baik.",
            "Ya Allah, lindungilah aku dari hal-hal yang tidak baik.", "Semoga hari ini penuh dengan rezeki yang berkah."
        ],
        morning_encouragements: [
            "Semoga hari ini membawa kabar baik!", "Kamu kuat, kamu mampu.", "Tarik napas, dunia menunggumu bersinar.",
            "Lakukan yang terbaik, sisanya biar Tuhan yang atur.", "Jangan lupa tersenyum pada diri sendiri.",
            "Satu langkah kecil hari ini adalah kemajuan besar."
        ],
        night_closings: [
            "Selamat tidur, orang baik.", "Mimpi indah. Dunia akan baik-baik saja.", "Sampai jumpa besok pagi.",
            "Istirahatlah, pikiranmu juga butuh jeda.", "Malam adalah selimut untuk jiwamu yang lelah.",
            "Tutup matamu, biarkan damai menyelimutimu."
        ],
        affirmations: [
            "Aku berharga.", "Tidak apa-apa untuk memulai lagi.", "Aku dicintai.", "Langkah kecil tetaplah kemajuan.",
            "Aku memegang kendali atas reaksiku.", "Hari ini penuh kemungkinan.", "Aku percaya pada kemampuanku.",
            "Aku berdamai dengan masa laluku.", "Aku bersyukur atas siapa diriku sekarang."
        ],
        quran_quotes: [
            { text: "Maka sesungguhnya bersama kesulitan ada kemudahan.", surah: "QS. Al-Insyirah: 5" },
            { text: "Allah tidak membebani seseorang melainkan sesuai kesanggupannya.", surah: "QS. Al-Baqarah: 286" },
            { text: "Ingatlah, hanya dengan mengingat Allah hati menjadi tenteram.", surah: "QS. Ar-Ra'd: 28" },
            { text: "Dan Tuhanmu Maha Pemaaf lagi mempunyai kasih sayang.", surah: "QS. Al-Kahfi: 58" },
            { text: "Sesungguhnya Tuhanku benar-benar Maha Dekat.", surah: "QS. Hud: 61" }
        ],
        defaultSpotify: { bloom: "https://open.spotify.com/embed/playlist/37i9dQZF1DX3rxVfibe1L0", rest: "https://open.spotify.com/embed/playlist/5WPQ7cTY0btImTvJfzEF7X" }
    };

    const MOODS = [
        { id: 'happy', emoji: 'üòÑ', label: 'Senang' }, { id: 'calm', emoji: 'üòä', label: 'Tenang' },
        { id: 'neutral', emoji: 'üòê', label: 'Biasa' }, { id: 'sad', emoji: 'üòî', label: 'Sedih' },
        { id: 'heavy', emoji: 'üò≠', label: 'Berat' }, { id: 'angry', emoji: 'üò°', label: 'Marah' }
    ];

    const Storage = {
        KEY_JOURNAL: 'bloom_rest_data', KEY_PLANNER: 'bloom_rest_planner', KEY_SETTINGS: 'bloom_rest_settings',
        getJournal() { return JSON.parse(localStorage.getItem(this.KEY_JOURNAL)) || {}; },
        getPlanner() { return JSON.parse(localStorage.getItem(this.KEY_PLANNER)) || [{ id: 1, title: 'Prioritas', tasks: [] }]; },
        getSettings() { return JSON.parse(localStorage.getItem(this.KEY_SETTINGS)) || { spotify_bloom: "", spotify_rest: "" }; },
        getTodayKey() { const n = new Date(); return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`; },
        saveJournal(k,t,d) { const a=this.getJournal(); if(!a[k])a[k]={}; a[k][t]={...a[k][t],...d}; localStorage.setItem(this.KEY_JOURNAL,JSON.stringify(a)); },
        savePlanner(d) { localStorage.setItem(this.KEY_PLANNER, JSON.stringify(d)); },
        saveSettings(d) { localStorage.setItem(this.KEY_SETTINGS, JSON.stringify(d)); },
        clear() { if(confirm("Hapus semua data?")) { localStorage.clear(); location.reload(); } }
    };

    const SpotifyHelper = { convertToEmbed(url) { if(!url) return null; if(url.includes('embed')) return url; try { const u=new URL(url); const p=u.pathname.split('/').filter(x=>x); if(p.length>=2) return `https://open.spotify.com/embed/${p[0]}/${p[1]}`; } catch(e){} return null; } };

    const BloomApp = {
        state: { moodBloom: null, moodRest: null, curMonth: new Date().getMonth(), curYear: new Date().getFullYear() },
        init() {
            this.setGreeting(); this.setDailyLyric(); this.loadSpotify(); this.planner.render(); this.planner.renderPreview();
            this.renderMoods('bloom-moods', 'bloom'); this.renderMoods('rest-moods', 'rest');
            this.renderHomeMorningSummary(); 
            document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('id-ID',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
        },
        setGreeting() { const h = new Date().getHours(); document.getElementById('greeting').innerText = h<11?"Selamat Pagi ‚òÄÔ∏è":h<15?"Selamat Siang üå§Ô∏è":h<18?"Selamat Sore üå•Ô∏è":"Selamat Malam üåô"; },
        setDailyLyric() { const r = DATA.lyrics[Math.floor(Math.random()*DATA.lyrics.length)]; document.getElementById('daily-lyric-text').innerText = `"${r.text}"`; document.getElementById('daily-lyric-source').innerText = r.source; },
        loadSpotify() { const s = Storage.getSettings(); document.getElementById('spotify-bloom').src = s.spotify_bloom || DATA.defaultSpotify.bloom; document.getElementById('spotify-rest').src = s.spotify_rest || DATA.defaultSpotify.rest; },
        renderMoods(id, type) { document.getElementById(id).innerHTML = MOODS.map(m => `<div class="mood-option" onclick="BloomApp.selectMood('${type}','${m.id}',this)"><span class="mood-emoji">${m.emoji}</span><span style="font-size:0.7rem;color:#888">${m.label}</span></div>`).join(''); },
        selectMood(type, id, el) { Array.from(el.parentElement.children).forEach(c=>c.classList.remove('selected')); el.classList.add('selected'); if(type==='bloom') this.state.moodBloom=id; else this.state.moodRest=id; },
        
        renderHomeMorningSummary() {
            const todayData = Storage.getJournal()[Storage.getTodayKey()];
            const container = document.getElementById('home-morning-summary');
            if (todayData && todayData.bloom) {
                let html = `<div class="card morning-summary-box"><h3>Fokus Hari Ini</h3>`;
                if(todayData.bloom.intention) html += `<p style="font-weight:600; font-style:italic; margin-bottom:10px; text-align:center;">"${todayData.bloom.intention}"</p>`;
                if(todayData.bloom.todos && todayData.bloom.todos.length > 0) {
                    todayData.bloom.todos.forEach(t => { html += `<div class="morning-item"><div class="morning-dot"></div><span class="text-xs">${t}</span></div>`; });
                }
                html += `</div>`;
                container.innerHTML = html;
                container.style.display = 'block';
            } else { container.style.display = 'none'; }
        },

        bloom: {
            save() {
                if(!BloomApp.state.moodBloom) return alert("Pilih mood dulu ya");
                const i = document.getElementById('bloom-intention').value;
                const t = Array.from(document.querySelectorAll('.todo-input')).map(x=>x.value).filter(x=>x.trim());
                Storage.saveJournal(Storage.getTodayKey(), 'bloom', { mood: BloomApp.state.moodBloom, intention: i, todos: t });
                BloomApp.overlay.showFlow('Pagi');
            }
        },
        rest: {
            saveAndStartFlow() {
                if(!BloomApp.state.moodRest) return alert("Pilih mood dulu ya");
                const r = document.getElementById('rest-recap').value;
                const g = document.getElementById('rest-gratitude').value;
                const review = document.getElementById('rest-review-note').value; 
                const totalTodos = document.querySelectorAll('#night-review-todos .task-check').length;
                const checkedTodos = document.querySelectorAll('#night-review-todos .task-check.checked').length;
                let isAllDone = false; let hasTodos = false;
                if (totalTodos > 0) { hasTodos = true; isAllDone = (totalTodos === checkedTodos); }
                Storage.saveJournal(Storage.getTodayKey(), 'rest', { mood: BloomApp.state.moodRest, recap: r, gratitude: g, intentionReview: review });
                BloomApp.overlay.startNightFlow(isAllDone, hasTodos);
            }
        },
        planner: {
            data: [],
            load() { this.data = Storage.getPlanner(); },
            render() { this.load(); const c = document.getElementById('planner-container'); c.innerHTML=''; if(this.data.length===0) c.innerHTML='<p class="text-light text-center">Kosong.</p>'; this.data.forEach((cat,i) => { let h = `<div class="category-group"><div class="category-header"><span class="category-title">${cat.title}</span><i class="ph ph-trash" style="color:#ff7675" onclick="BloomApp.planner.delCat(${i})"></i></div>`; cat.tasks.forEach((t,j) => h+=`<div class="task-item"><div class="task-check ${t.done?'checked':''}" onclick="BloomApp.planner.tog(${i},${j})"></div><span class="task-text ${t.done?'done':''}">${t.text}</span><i class="ph ph-trash delete-task" onclick="BloomApp.planner.delTask(${i},${j})"></i></div>`); h+=`<div class="add-task-wrapper"><input id="nt-${i}" placeholder="+ Tugas" style="margin:0;"><button class="btn-primary btn-icon" style="width:36px;height:36px" onclick="BloomApp.planner.add(${i})">+</button></div></div>`; c.innerHTML += h; }); },
            renderPreview() { this.load(); const p = document.getElementById('home-tasks-preview'); let all=[]; this.data.forEach(c=>c.tasks.forEach(t=>{if(!t.done)all.push(t.text)})); p.innerHTML = all.length ? all.slice(0,3).map(t=>`<div style="display:flex;gap:8px;align-items:center;margin-bottom:4px"><div style="width:6px;height:6px;background:var(--primary-dark);border-radius:50%"></div><span class="text-xs">${t}</span></div>`).join('') : '<p class="text-light text-xs">Semua selesai!</p>'; },
            addCategoryPrompt() { const t=prompt("Nama Kategori:"); if(t){ this.data.push({id:Date.now(),title:t,tasks:[]}); Storage.savePlanner(this.data); this.render(); } },
            delCat(i) { if(confirm("Hapus?")){ this.data.splice(i,1); Storage.savePlanner(this.data); this.render(); } },
            add(i) { const el=document.getElementById(`nt-${i}`); if(el.value.trim()){ this.data[i].tasks.push({text:el.value,done:false}); Storage.savePlanner(this.data); this.render(); this.renderPreview(); } },
            tog(i,j) { this.data[i].tasks[j].done=!this.data[i].tasks[j].done; Storage.savePlanner(this.data); this.render(); this.renderPreview(); },
            delTask(i,j) { this.data[i].tasks.splice(j,1); Storage.savePlanner(this.data); this.render(); this.renderPreview(); }
        },
        overlay: {
            el: document.getElementById('gratitude-overlay'), title: document.getElementById('overlay-title'), text: document.getElementById('overlay-text'), icon: document.getElementById('overlay-icon'), acts: document.getElementById('overlay-actions'),
            nightState: { isAllDone: false, hasTodos: false },
            showFlow(type) {
                this.el.classList.add('show');
                this.icon.classList.remove('pat-animation');
                if(type==='Pagi') {
                    this.title.innerText = "Doa Pagi"; this.icon.className="ph-fill ph-sun-horizon"; this.icon.style.color="#FFB74D";
                    this.text.innerText = DATA.morning_prayers[Math.floor(Math.random()*DATA.morning_prayers.length)];
                    this.acts.innerHTML = `<button class="btn btn-primary" onclick="BloomApp.overlay.nextPagi()">Aamiin</button>`;
                } else {
                    this.title.innerText = "Terima Kasih"; this.icon.className="ph-fill ph-heart"; this.icon.style.color="#E57373";
                    this.text.innerText = DATA.gratitude_prompts[Math.floor(Math.random()*DATA.gratitude_prompts.length)];
                    this.acts.innerHTML = `<button class="btn btn-primary" onclick="BloomApp.overlay.nextMalam()">Lanjut</button>`;
                }
            },
            startNightFlow(isAllDone, hasTodos) {
                this.nightState = { isAllDone, hasTodos };
                this.showFlow('Malam');
            },
            nextPagi() {
                this.title.innerText = "Semangat!"; this.icon.className="ph-fill ph-sparkle"; this.text.innerText = DATA.morning_encouragements[Math.floor(Math.random()*DATA.morning_encouragements.length)];
                this.acts.innerHTML = `<button class="btn btn-primary" onclick="BloomApp.overlay.close()">Mulai Hari</button>`;
            },
            nextMalam() {
                this.title.innerText = "Selamat Malam"; this.icon.className="ph-fill ph-moon-stars"; this.icon.style.color="#5C6BC0";
                this.text.innerText = DATA.night_closings[Math.floor(Math.random()*DATA.night_closings.length)];
                this.acts.innerHTML = `<button class="btn btn-primary" onclick="BloomApp.overlay.showPatPat()">Tidur Nyenyak</button>`;
            },
            showPatPat() {
                this.title.innerText = "Good Job!"; 
                this.icon.className="ph-fill ph-hand-heart pat-animation"; 
                this.icon.style.color="#FFAB91";
                if (this.nightState.hasTodos) {
                    if (this.nightState.isAllDone) { this.text.innerText = "Hebat! Tuntas semua. Terima kasih sudah berjuang hari ini."; } 
                    else { this.text.innerText = "Gapapa kalau belum semua, kita nggak lagi lomba kok. Kamu sudah berusaha, itu cukup."; }
                } else { this.text.innerText = "Kamu sudah melakukan yang terbaik hari ini. Istirahatlah dengan tenang."; }
                this.acts.innerHTML = `<p class="text-xs text-light" style="margin-top:10px;">Menutup dalam 4 detik...</p>`;
                setTimeout(() => { BloomApp.overlay.close(); }, 4000);
            },
            close() { this.el.classList.remove('show'); BloomApp.router.go('calendar'); BloomApp.init(); }
        },
        fortune: { open() { document.getElementById('cookie-closed').style.display='none'; document.getElementById('cookie-opened').style.display='block'; document.getElementById('fortune-text').innerText = `"${DATA.affirmations[Math.floor(Math.random()*DATA.affirmations.length)]}"`; }, reset() { document.getElementById('cookie-opened').style.display='none'; document.getElementById('cookie-closed').style.display='block'; } },
        quran: { open() { document.getElementById('quran-closed').style.display='none'; document.getElementById('quran-opened').style.display='block'; const q = DATA.quran_quotes[Math.floor(Math.random()*DATA.quran_quotes.length)]; document.getElementById('quran-text').innerText = `"${q.text}"`; document.getElementById('quran-surah').innerText = q.surah; }, reset() { document.getElementById('quran-opened').style.display='none'; document.getElementById('quran-closed').style.display='block'; } },
        calendar: {
            render() {
                const d=new Date(BloomApp.state.curYear, BloomApp.state.curMonth, 1); document.getElementById('cal-month-year').innerText = d.toLocaleDateString('id-ID',{month:'long',year:'numeric'}); const c = document.getElementById('calendar-days'); c.innerHTML='';
                for(let i=0;i<d.getDay();i++) c.innerHTML+=`<div class="calendar-day" style="background:transparent;cursor:default"></div>`;
                const dim = new Date(BloomApp.state.curYear, BloomApp.state.curMonth+1,0).getDate(); const all = Storage.getJournal();
                for(let i=1;i<=dim;i++) { 
                    const k=`${BloomApp.state.curYear}-${String(BloomApp.state.curMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; 
                    const dt=all[k]; 
                    let cls=''; 
                    let content = `<span>${i}</span>`;
                    
                    if(dt){ 
                        const m=dt.rest?.mood||dt.bloom?.mood; 
                        if(m) {
                            cls=`day-${m}`; 
                            // Add mood emoji
                            const moodEmoji = MOODS.find(x => x.id === m)?.emoji || '';
                            if(moodEmoji) content += `<span style="font-size:0.7rem; margin-top: -2px;">${moodEmoji}</span>`;
                        }
                    } 
                    if(k===Storage.getTodayKey()) cls+=' day-today'; 
                    c.innerHTML+=`<div class="calendar-day ${cls}" onclick="BloomApp.calendar.show('${k}')">${content}</div>`; 
                }
            },
            prevMonth() { BloomApp.state.curMonth--; if(BloomApp.state.curMonth<0){BloomApp.state.curMonth=11;BloomApp.state.curYear--;} this.render(); }, nextMonth() { BloomApp.state.curMonth++; if(BloomApp.state.curMonth>11){BloomApp.state.curMonth=0;BloomApp.state.curYear++;} this.render(); },
            show(k) {
                const d=Storage.getJournal()[k]; if(!d) return;
                document.getElementById('day-detail-panel').style.display='block'; document.getElementById('detail-date').innerText=k;
                const m=id=>id?MOODS.find(x=>x.id===id)?.label||'-':'-';
                document.getElementById('detail-bloom-mood').innerText=m(d.bloom?.mood); document.getElementById('detail-intention').innerText=d.bloom?.intention||'-';
                document.getElementById('detail-rest-mood').innerText=m(d.rest?.mood); document.getElementById('detail-recap').innerText=d.rest?.recap||'-'; document.getElementById('detail-gratitude').innerText=d.rest?.gratitude||'-';
            }
        },
        settings: { saveSpotify() { const b=SpotifyHelper.convertToEmbed(document.getElementById('setting-spotify-bloom').value); const r=SpotifyHelper.convertToEmbed(document.getElementById('setting-spotify-rest').value); Storage.saveSettings({ spotify_bloom: b||document.getElementById('setting-spotify-bloom').value, spotify_rest: r||document.getElementById('setting-spotify-rest').value }); BloomApp.loadSpotify(); alert("Disimpan!"); } },
        router: {
            go(id) {
                document.querySelectorAll('.view').forEach(e=>e.classList.remove('active')); document.getElementById(`view-${id}`).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); 
                const navItem = document.querySelector(`.nav-item[data-target="${id}"]`);
                if(navItem) navItem.classList.add('active');
                
                const bg = document.getElementById('global-bg'); document.querySelectorAll('.decoration-layer').forEach(d=>d.classList.remove('active'));
                bg.className = ''; 
                
                if(id==='home') { 
                    bg.classList.add('bg-home'); 
                    document.getElementById('deco-home').classList.add('active'); 
                    document.body.classList.remove('dark-theme'); 
                    BloomApp.renderHomeMorningSummary(); 
                }
                else if(id==='settings') {
                    bg.classList.add('bg-settings'); // Updated to use specific settings background
                    document.getElementById('deco-settings').classList.add('active'); // Wind lines
                    document.body.classList.remove('dark-theme');
                }
                else if(id === 'planner') {
                    bg.classList.add('bg-planner'); 
                    document.getElementById('deco-planner').classList.add('active'); 
                    document.body.classList.add('dark-theme'); 
                }
                else if(id==='bloom') { bg.classList.add('bg-bloom'); document.getElementById('deco-bloom').classList.add('active'); document.body.classList.remove('dark-theme'); }
                else if(id==='rest') { 
                    bg.classList.add('bg-rest'); document.getElementById('deco-rest').classList.add('active'); document.body.classList.add('dark-theme'); 
                    const todayData = Storage.getJournal()[Storage.getTodayKey()];
                    const reviewSec = document.getElementById('night-review-section');
                    const todoContainer = document.getElementById('night-review-todos');
                    if(todayData && todayData.bloom) {
                        reviewSec.style.display = 'block';
                        if(todayData.bloom.intention) {
                             document.getElementById('review-intention-text').innerText = `"${todayData.bloom.intention}"`;
                             document.getElementById('review-intention-wrapper').style.display = 'block';
                        } else { document.getElementById('review-intention-wrapper').style.display = 'none'; }
                        if(todayData.bloom.todos && todayData.bloom.todos.length > 0) {
                            let todoHtml = '<p class="text-xs" style="text-align:center; margin-top:10px;">Ceklis yang terlaksana ya:</p>';
                            todayData.bloom.todos.forEach((t, i) => { todoHtml += `<div class="task-item" style="background:white; cursor:pointer;" onclick="this.querySelector('.task-check').classList.toggle('checked')"><div class="task-check" id="night-check-${i}"></div><span class="task-text">${t}</span></div>`; });
                            todoContainer.innerHTML = todoHtml; todoContainer.style.display = 'block';
                        } else { todoContainer.style.display = 'none'; }
                    } else { reviewSec.style.display = 'none'; }
                }
                else if(id==='calendar') { 
                    bg.classList.add('bg-journal'); 
                    document.getElementById('deco-journal').classList.add('active'); 
                    document.body.classList.remove('dark-theme'); 
                    BloomApp.calendar.render(); 
                }
                
                if(id==='planner') BloomApp.planner.render(); window.scrollTo(0,0);
            }
        }
    };
    document.addEventListener('DOMContentLoaded', ()=>BloomApp.init());
</script>
</body>
</html>