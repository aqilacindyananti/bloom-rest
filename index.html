<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloom & Rest - Journaling</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* =========================================
           STYLE & THEME
           ========================================= */
        :root {
            /* Palette Default */
            --bg-color: #FDFBF7;
            --text-main: #2D3436;
            --text-light: #636E72;
            
            --primary-soft: #E8DFF5;
            --primary-dark: #8E7CC3;
            --accent-pink: #FFC3A0;
            --accent-blue: #A0C4FF;
            --accent-gold: #FFEAA7; 
            
            /* Mood Colors */
            --mood-happy: #FFEAA7; 
            --mood-calm: #55EFC4; 
            --mood-neutral: #DFE6E9; 
            --mood-sad: #74B9FF; 
            --mood-heavy: #A29BFE; 
            --mood-angry: #FF7675; 

            --card-bg: rgba(255, 255, 255, 0.85);
            --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.05);
            --border-glass: 1px solid rgba(255, 255, 255, 0.6);
            --radius-lg: 24px;
            --radius-md: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            overflow-x: hidden;
            position: relative;
            transition: background 0.5s ease, color 0.3s ease;
        }

        /* --- THEME MODES (BACKGROUNDS) --- */
        .bg-decoration {
            position: fixed;
            border-radius: 50%;
            filter: blur(60px);
            z-index: -1;
            opacity: 0.6;
            animation: float 10s infinite ease-in-out alternate;
            transition: opacity 0.5s;
        }
        .blob-1 { top: -10%; left: -10%; width: 300px; height: 300px; background: var(--primary-soft); }
        .blob-2 { bottom: 10%; right: -5%; width: 250px; height: 250px; background: var(--accent-pink); animation-delay: 2s; }
        .blob-3 { top: 40%; left: 30%; width: 200px; height: 200px; background: var(--accent-blue); opacity: 0.4; animation-delay: 4s; }

        /* MODE: MORNING (Bloom) */
        body.mode-bloom {
            background: linear-gradient(180deg, #89f7fe 0%, #66a6ff 100%);
        }
        body.mode-bloom .bg-decoration { opacity: 0; }
        
        /* Clouds Decoration */
        .cloud-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }
        body.mode-bloom .cloud-container { opacity: 1; }

        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50px;
            animation: moveCloud linear infinite;
        }
        .cloud::after {
            content: ''; position: absolute; background: inherit; border-radius: 50%;
            width: 50%; height: 150%; top: -60%; left: 15%;
        }
        .cloud::before {
            content: ''; position: absolute; background: inherit; border-radius: 50%;
            width: 40%; height: 120%; top: -45%; right: 15%;
        }
        
        @keyframes moveCloud {
            from { transform: translateX(-100%); }
            to { transform: translateX(100vw); }
        }

        /* MODE: NIGHT (Rest) */
        body.mode-rest {
            background: linear-gradient(180deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #fff;
        }
        body.mode-rest .bg-decoration { opacity: 0; }
        
        body.mode-rest h1, body.mode-rest h2, body.mode-rest h3, body.mode-rest h4, 
        body.mode-rest .btn-icon { color: #fff; }
        
        /* Stars Decoration */
        .star-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }
        body.mode-rest .star-container { opacity: 1; }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* --- Main Layout --- */
        #app {
            width: 100%;
            max-width: 480px; 
            min-height: 100vh;
            position: relative;
            padding-bottom: 90px;
            display: flex;
            flex-direction: column;
        }

        @keyframes float {
            0% { transform: translate(0, 0); }
            100% { transform: translate(20px, 40px); }
        }

        /* --- Components --- */
        h1, h2, h3, h4 { font-family: 'Quicksand', sans-serif; font-weight: 700; color: inherit; }
        h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
        h2 { font-size: 1.5rem; margin-bottom: 1rem; }
        p { line-height: 1.6; font-size: 0.95rem; }
        .text-light { color: var(--text-light); font-size: 0.85rem; }
        .text-xs { font-size: 0.75rem; color: var(--text-light); }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--border-glass);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-soft);
            margin-bottom: 1.5rem;
            transition: transform 0.2s ease;
            color: var(--text-main) !important;
        }
        .card h1, .card h2, .card h3, .card h4, .card p, .card span { color: var(--text-main); } 

        .btn {
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .btn-primary { 
            background: var(--primary-dark); 
            color: white !important; 
            box-shadow: 0 4px 15px rgba(142, 124, 195, 0.4);
        }
        .btn-primary:active { transform: scale(0.98); }
        
        .btn-soft { background: var(--primary-soft); color: var(--primary-dark); }
        .btn-outline { border: 2px solid var(--primary-soft); background: transparent; color: inherit; } 
        .card .btn-outline { color: var(--text-main); } 
        
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; }
        .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); }

        input[type="text"], textarea, select {
            width: 100%;
            padding: 14px;
            border: 2px solid rgba(0,0,0,0.05);
            border-radius: var(--radius-md);
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1rem;
            margin-bottom: 1rem;
            outline: none;
            transition: 0.3s;
            background: rgba(255,255,255,0.6);
            color: var(--text-main) !important;
        }
        input:focus, textarea:focus { border-color: var(--primary-dark); background: #FFF; }

        /* --- Navigation --- */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 440px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 12px 20px;
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            color: var(--text-light);
            cursor: pointer;
            transition: 0.3s;
            position: relative;
        }
        .nav-item i { font-size: 1.6rem; margin-bottom: 2px; transition: 0.3s; }
        .nav-item.active { color: var(--primary-dark); font-weight: 600; }
        .nav-item.active i { transform: translateY(-3px); }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: -5px; width: 4px; height: 4px;
            background: var(--primary-dark); border-radius: 50%;
        }

        /* --- Views --- */
        .view { display: none; padding: 20px; animation: fadeIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Planner Styles --- */
        .task-item {
            display: flex; align-items: center; background: rgba(255,255,255,0.6);
            padding: 10px; border-radius: 12px; margin-bottom: 8px; border: 1px solid transparent; transition: 0.2s;
            color: var(--text-main);
        }
        .task-item:hover { background: white; border-color: var(--primary-soft); }
        .task-check {
            min-width: 22px; height: 22px; border: 2px solid var(--primary-dark); border-radius: 6px;
            margin-right: 12px; display: grid; place-items: center; cursor: pointer;
        }
        .task-check.checked { background: var(--primary-dark); }
        .task-check.checked::after { content: '‚úî'; color: white; font-size: 12px; }
        .task-text { flex: 1; font-size: 0.95rem; }
        .task-text.done { text-decoration: line-through; opacity: 0.5; }
        .delete-task { color: #ff7675; opacity: 0; cursor: pointer; padding: 5px; }
        .task-item:hover .delete-task { opacity: 1; }
        .category-title {
            font-size: 1.1rem; font-weight: 700; color: var(--primary-dark);
            background: var(--primary-soft); padding: 4px 12px; border-radius: 20px;
        }
        .category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .category-group { margin-bottom: 24px; }

        /* --- Mood Grid --- */
        .mood-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 1.5rem; }
        .mood-option {
            background: rgba(255,255,255,0.5); padding: 15px 5px; border-radius: var(--radius-md);
            text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.3s;
            color: var(--text-main);
        }
        .mood-option:hover { background: white; }
        .mood-option.selected { border-color: var(--primary-dark); background: white; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .mood-emoji { font-size: 2rem; display: block; margin-bottom: 5px; }

        /* --- Calendar --- */
        .calendar-day {
            aspect-ratio: 1; border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; background: rgba(255,255,255,0.5); cursor: pointer; position: relative; font-weight: 600;
            color: var(--text-main);
        }
        .day-happy { background-color: var(--mood-happy); color: #5d5438; }
        .day-calm { background-color: var(--mood-calm); color: #2d5e50; }
        .day-neutral { background-color: var(--mood-neutral); }
        .day-sad { background-color: var(--mood-sad); color: white; }
        .day-heavy { background-color: var(--mood-heavy); color: white; }
        .day-angry { background-color: var(--mood-angry); color: #7c2d2d; }
        .day-today { border: 2px solid var(--text-main); }
        
        /* Overlays */
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95);
            z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center; opacity: 0; pointer-events: none; transition: 0.5s;
            color: var(--text-main) !important;
        }
        .overlay h2, .overlay p { color: var(--text-main) !important; }
        .overlay.show { opacity: 1; pointer-events: all; }

        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }
        .reveal-card:hover .reveal-icon {
            animation: shake 0.5s ease-in-out infinite;
        }

    </style>
</head>
<body>

<!-- Background Decorations (Default) -->
<div class="bg-decoration blob-1"></div>
<div class="bg-decoration blob-2"></div>
<div class="bg-decoration blob-3"></div>

<!-- Background Decorations (Morning) -->
<div class="cloud-container">
    <div class="cloud" style="width: 120px; height: 40px; top: 10%; left: -20%; animation-duration: 25s;"></div>
    <div class="cloud" style="width: 100px; height: 35px; top: 25%; left: -10%; animation-duration: 35s; opacity: 0.7;"></div>
    <div class="cloud" style="width: 140px; height: 45px; top: 60%; left: -25%; animation-duration: 30s; opacity: 0.8;"></div>
</div>

<!-- Background Decorations (Night) -->
<div class="star-container">
    <div class="star" style="width: 3px; height: 3px; top: 10%; left: 20%; animation-delay: 0s;"></div>
    <div class="star" style="width: 4px; height: 4px; top: 20%; left: 80%; animation-delay: 1s;"></div>
    <div class="star" style="width: 2px; height: 2px; top: 35%; left: 40%; animation-delay: 2s;"></div>
    <div class="star" style="width: 3px; height: 3px; top: 50%; left: 10%; animation-delay: 1.5s;"></div>
    <div class="star" style="width: 4px; height: 4px; top: 65%; left: 85%; animation-delay: 0.5s;"></div>
    <div class="star" style="width: 2px; height: 2px; top: 80%; left: 30%; animation-delay: 3s;"></div>
    <div class="star" style="width: 5px; height: 5px; top: 15%; left: 60%; animation-delay: 2.2s;"></div>
    <div class="star" style="width: 3px; height: 3px; top: 5%; left: 90%; animation-delay: 0.8s;"></div>
</div>

<div id="app">
    
    <!-- ================= VIEW: HOME ================= -->
    <div id="view-home" class="view active">
        <div style="padding-top: 2rem; display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h1 id="greeting">Halo, Kamu.</h1>
                <p class="text-light" id="current-date-display">Jumat, 2 Januari 2026</p>
            </div>
            <div style="background: white; padding: 10px; border-radius: 50%; box-shadow: var(--shadow-soft);">
                <i class="ph-fill ph-plant" style="font-size: 2rem; color: var(--primary-dark);"></i>
            </div>
        </div>

        <div style="margin-top: 2rem;">
            <!-- Lyric of the day (Replaces Quote) -->
            <div class="card" style="text-align: center; position: relative; overflow: hidden;">
                <i class="ph-fill ph-spotify-logo" style="font-size: 3rem; color: #1DB954; position: absolute; top: -10px; left: 10px; opacity: 0.2;"></i>
                <p id="daily-lyric-text" style="font-style: italic; font-weight: 500; font-size: 1.1rem; margin-top: 10px; margin-bottom: 5px;">"..."</p>
                <p id="daily-lyric-source" class="text-xs text-light">Song - Artist</p>
            </div>

            <!-- Mini Games / Reminders Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 1.5rem;">
                
                <!-- Fortune Cookie -->
                <div class="card reveal-card" id="fortune-cookie-card" style="margin-bottom: 0; text-align: center; cursor: pointer; border: 2px dashed #D4A373; padding: 1rem;" onclick="app.fortune.open()">
                    <div id="cookie-closed">
                        <div class="reveal-icon" style="display:inline-block;">
                            <i class="ph-fill ph-cookie" style="font-size: 2.5rem; color: #D4A373;"></i>
                        </div>
                        <p style="font-size: 0.85rem; font-weight: 600; color: #D4A373;">Fortune Cookie</p>
                    </div>
                    <div id="cookie-opened" style="display: none; animation: fadeIn 0.5s;">
                        <p class="text-xs text-light">Kata hari ini:</p>
                        <p id="fortune-text" style="font-size: 0.85rem; font-weight: 600; color: var(--primary-dark); margin: 5px 0;">"..."</p>
                        <button class="btn-outline btn-sm" style="border-radius: 20px; font-size: 0.7rem; padding: 4px 8px;" onclick="event.stopPropagation(); app.fortune.reset()">Tutup</button>
                    </div>
                </div>

                <!-- Quran / Divine Reminder -->
                <div class="card reveal-card" id="quran-card" style="margin-bottom: 0; text-align: center; cursor: pointer; border: 2px dashed #81C784; padding: 1rem;" onclick="app.quran.open()">
                    <div id="quran-closed">
                        <div class="reveal-icon" style="display:inline-block;">
                            <i class="ph-fill ph-book-open-text" style="font-size: 2.5rem; color: #81C784;"></i>
                        </div>
                        <p style="font-size: 0.85rem; font-weight: 600; color: #81C784;">Pesan Langit</p>
                    </div>
                    <div id="quran-opened" style="display: none; animation: fadeIn 0.5s;">
                        <p id="quran-text" style="font-size: 0.85rem; font-weight: 600; color: #2E7D32; margin: 5px 0;">"..."</p>
                        <p id="quran-surah" style="font-size: 0.7rem; color: #81C784; font-style: italic; margin-bottom: 5px;">QS...</p>
                        <button class="btn-outline btn-sm" style="border-radius: 20px; font-size: 0.7rem; padding: 4px 8px; border-color: #81C784; color: #2E7D32;" onclick="event.stopPropagation(); app.quran.reset()">Tutup</button>
                    </div>
                </div>

            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <!-- Morning Action -->
                <div class="card" style="margin-bottom: 0; background: linear-gradient(135deg, #fff 0%, #FFF8E1 100%); cursor: pointer;" onclick="app.router.go('bloom')">
                    <i class="ph-fill ph-sun" style="font-size: 2rem; color: #FFB74D; margin-bottom: 10px;"></i>
                    <h3>Morning</h3>
                    <p class="text-light text-xs">Mulai hari dengan niat.</p>
                </div>

                <!-- Night Action -->
                <div class="card" style="margin-bottom: 0; background: linear-gradient(135deg, #fff 0%, #E3F2FD 100%); cursor: pointer;" onclick="app.router.go('rest')">
                    <i class="ph-fill ph-moon-stars" style="font-size: 2rem; color: #5C6BC0; margin-bottom: 10px;"></i>
                    <h3>Night</h3>
                    <p class="text-light text-xs">Tutup hari dengan tenang.</p>
                </div>
            </div>

            <!-- Quick Todo Preview -->
            <div class="card" style="margin-top: 1.5rem;" onclick="app.router.go('planner')">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3>üéØ Minggu Ini</h3>
                    <span class="text-light text-xs">Lihat Semua ></span>
                </div>
                <div id="home-tasks-preview">
                    <!-- Preview tasks injected here -->
                    <p class="text-light text-xs">Belum ada tugas.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= VIEW: BLOOM (PAGI) ================= -->
    <div id="view-bloom" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
            <h2 style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">‚òÄÔ∏è Morning Bloom</h2>
            <button class="btn-icon" onclick="app.router.go('home')"><i class="ph ph-x"></i></button>
        </div>

        <div class="card" style="padding: 0; overflow: hidden;">
            <div style="padding: 15px; background: rgba(255,255,255,0.5);">
                <h4 style="display:flex; align-items:center; gap:8px;"><i class="ph-fill ph-music-note"></i> Lagu Semangat Pagi</h4>
            </div>
            <iframe id="spotify-bloom" style="border-radius:0px 0px 12px 12px" src="" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom:15px;">Mood Check-in</h3>
            <div class="mood-selector" id="bloom-moods"></div>
        </div>

        <div class="card">
            <h3>Intention</h3>
            <p class="text-light" style="margin-bottom: 10px;">Satu niat kecil untuk hari ini?</p>
            <input type="text" id="bloom-intention" placeholder="Hari ini aku ingin lebih...">
        </div>

        <div class="card">
            <h3>Tiny To-Do (Hari Ini)</h3>
            <div id="todo-container">
                <input type="text" class="todo-input" placeholder="1. Fokus utama...">
                <input type="text" class="todo-input" placeholder="2. ...">
                <input type="text" class="todo-input" placeholder="3. ...">
            </div>
        </div>

        <button class="btn btn-primary" onclick="app.bloom.save()">Simpan Bloom</button>
        <br><br><br>
    </div>

    <!-- ================= VIEW: REST (MALAM) ================= -->
    <div id="view-rest" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
            <h2>üåô Night Rest</h2>
            <button class="btn-icon" onclick="app.router.go('home')"><i class="ph ph-x"></i></button>
        </div>

        <div class="card" style="padding: 0; overflow: hidden;">
            <div style="padding: 15px; background: rgba(255,255,255,0.5);">
                <h4 style="display:flex; align-items:center; gap:8px;"><i class="ph-fill ph-moon"></i> Pengantar Tidur</h4>
            </div>
            <iframe id="spotify-rest" style="border-radius:0px 0px 12px 12px" src="" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
        </div>
        
        <div class="card">
            <h3>Mood Closing</h3>
            <div class="mood-selector" id="rest-moods"></div>
        </div>

        <div class="card">
            <h3>Day Recap</h3>
            <textarea id="rest-recap" rows="3" placeholder="Ceritakan sedikit tentang harimu..."></textarea>
        </div>

        <div class="card">
            <h3>Refleksi</h3>
            <div style="margin-bottom: 10px;">
                <label class="text-xs" style="font-weight:600; color: var(--primary-dark);">WIN OF THE DAY</label>
                <input type="text" id="rest-ref1" placeholder="Apa yang berjalan baik?">
            </div>
            <div>
                <label class="text-xs" style="font-weight:600; color: #ff7675;">LETTING GO</label>
                <input type="text" id="rest-ref2" placeholder="Apa yang ingin dilepaskan?">
            </div>
        </div>

        <div class="card">
            <h3>1 Gratitude</h3>
            <input type="text" id="rest-gratitude" placeholder="Aku bersyukur karena...">
        </div>

        <button class="btn btn-primary" onclick="app.rest.saveAndStartFlow()">Selesai & Istirahat</button>
        <br><br><br>
    </div>

    <!-- ================= VIEW: WEEKLY PLANNER ================= -->
    <div id="view-planner" class="view">
        <h2>üìù Tugas Minggu Ini</h2>
        <p class="text-light" style="margin-bottom: 1.5rem;">Atur targetmu sesuai kategori sesukamu.</p>

        <div id="planner-container"></div>
        <button class="btn btn-outline" onclick="app.planner.addCategoryPrompt()">+ Tambah Kategori Baru</button>
        <br><br><br> 
    </div>

    <!-- ================= VIEW: CALENDAR ================= -->
    <div id="view-calendar" class="view">
        <h2>üìÖ Mood Calendar</h2>
        
        <div class="card">
            <div class="calendar-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <button class="btn-icon" style="background:var(--primary-soft)" onclick="app.calendar.prevMonth()">&lt;</button>
                <h3 id="cal-month-year">Januari 2026</h3>
                <button class="btn-icon" style="background:var(--primary-soft)" onclick="app.calendar.nextMonth()">&gt;</button>
            </div>
            
            <div class="calendar-grid" style="display:grid; grid-template-columns:repeat(7, 1fr); gap:8px;">
                <div class="day-name">Min</div><div class="day-name">Sen</div><div class="day-name">Sel</div>
                <div class="day-name">Rab</div><div class="day-name">Kam</div><div class="day-name">Jum</div><div class="day-name">Sab</div>
            </div>
            <div id="calendar-days" class="calendar-grid" style="display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; margin-top:10px;"></div>
        </div>

        <div id="day-detail-panel" class="card" style="display:none; animation: fadeIn 0.3s;">
            <h3 id="detail-date" style="color:var(--primary-dark)">Detail</h3>
            <div style="margin-top: 15px; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 12px;">
                <p class="text-xs">PAGI</p>
                <p><strong>Mood:</strong> <span id="detail-bloom-mood">-</span></p>
                <p class="text-light" id="detail-intention">-</p>
            </div>
            <div style="margin-top: 10px; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 12px;">
                <p class="text-xs">MALAM</p>
                <p><strong>Mood:</strong> <span id="detail-rest-mood">-</span></p>
                <p class="text-light" id="detail-recap">-</p>
                <p class="text-light" style="margin-top:5px; color: var(--primary-dark); font-weight:600;">‚ú® <span id="detail-gratitude">-</span></p>
            </div>
        </div>
        <br><br><br>
    </div>

    <!-- ================= VIEW: SETTINGS ================= -->
    <div id="view-settings" class="view">
        <h2>‚öôÔ∏è Pengaturan</h2>
        <div class="card">
            <h3>üéµ Link Spotify</h3>
            <p class="text-light text-xs">Masukkan link Playlist/Lagu/Album dari Spotify (Klik Share > Copy Link).</p>
            <div style="margin-top: 15px;">
                <label class="text-xs">Lagu Pagi (Semangat)</label>
                <input type="text" id="setting-spotify-bloom" placeholder="Paste link Spotify di sini...">
            </div>
            <div>
                <label class="text-xs">Lagu Malam (Tenang)</label>
                <input type="text" id="setting-spotify-rest" placeholder="Paste link Spotify di sini...">
            </div>
            <button class="btn btn-primary btn-sm" onclick="app.settings.saveSpotify()">Simpan Lagu</button>
        </div>
        <div class="card">
            <h3>Data</h3>
            <button class="btn btn-outline" style="color: #ff6b6b; border-color: #ff6b6b;" onclick="app.storage.clear()">Reset Semua Data</button>
        </div>
    </div>

    <!-- ================= OVERLAY ================= -->
    <div id="gratitude-overlay" class="overlay">
        <div id="overlay-content" style="width: 100%; max-width: 400px;">
            <i class="ph-fill ph-heart" id="overlay-icon" style="font-size: 4rem; color: var(--primary-dark); margin-bottom: 20px; animation: breathe 3s infinite;"></i>
            <h2 id="overlay-title" style="font-size: 2rem;">Title</h2>
            <p id="overlay-text" style="font-size: 1.3rem; margin-bottom: 40px; font-weight: 500;">"..."</p>
            <div id="overlay-actions"></div>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="app.router.go('home')" data-target="home">
            <i class="ph ph-house"></i>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="app.router.go('planner')" data-target="planner">
            <i class="ph ph-list-checks"></i>
            <span>Tugas</span>
        </div>
        <div class="nav-item" onclick="app.router.go('calendar')" data-target="calendar">
            <i class="ph ph-calendar-heart"></i>
            <span>Jurnal</span>
        </div>
        <div class="nav-item" onclick="app.router.go('settings')" data-target="settings">
            <i class="ph ph-gear"></i>
            <span>Settings</span>
        </div>
    </div>

</div>

<script>
    /* =========================================
       DATA & CONSTANTS
       ========================================= */
    const DATA = {
        lyrics: [
            // INDONESIA
            { text: "Tenangkan hati, semua ini bukan salahmu. Jangan berhenti yang kau takutkan takkan terjadi.", source: "Rehat - Kunto Aji" },
            { text: "Bernafaslah sejenak, lupakanlah beban di pundak.", source: "Rehat - Kunto Aji" },
            { text: "Yang patah tumbuh, yang hilang berganti.", source: "Yang Patah Tumbuh - Banda Neira" },
            { text: "Kita manusia, wajar jika tak sempurna. Saat kau jatuh, bangkitlah perlahan.", source: "Memulai Kembali - Monita Tahalea" },
            { text: "Luka-luka hilanglah lara. Kau berharga, kau berhak bahagia.", source: "Diri - Tulus" },
            { text: "Katakan pada dirimu: 'Terima kasih sudah bertahan hebat hingga kini'.", source: "Diri - Tulus" },
            { text: "Maafkan semua yang lalu, ampuni hati kecilmu.", source: "Diri - Tulus" },
            { text: "Kau bisa patahkan kakiku, tapi tidak mimpi-mimpiku. Kau manusia kuat.", source: "Manusia Kuat - Tulus" },
            { text: "Aku tak sempurna, tak perlu sempurna. Akan kurayakan apa adanya.", source: "Tutur Batin - Yura Yunita" },
            { text: "Kau terjatuh dan terjaga, kau sedih dan bahagia. Kau tetap indah.", source: "Tenang - Yura Yunita" },
            { text: "Perjalanan masih panjang, tak perlu tergesa-gesa. Masalah pelik percaya kan reda.", source: "Evaluasi - Hindia" },
            { text: "Apapun yang kau yakini, semoga itu yang kau dapati.", source: "Secukupnya - Hindia" },
            { text: "Untungnya bumi masih berputar, untungnya ku tak pilih menyerah.", source: "Untungnya - Bernadya" },
            { text: "Takut tambah dewasa, takut aku kecewa. Takut tak seindah yang kukira.", source: "Takut - Idgitaf" },
            { text: "Cukupkanlah, ikat rambutmu. Basuh wajahmu, dunia belum berakhir.", source: "Beranjak Dewasa - Nadin Amizah" },
            { text: "Langit dan laut saling membantu, membenih hujan, mengirim rindu.", source: "Sorai - Nadin Amizah" },
            { text: "Biar ku gendong pulang, kau mengantuk, biar ku gendong pulang.", source: "Ikat Aku di Tulang Belikatmu - Sal Priadi" },
            { text: "Bahagia itu sederhana, sesederhana kamu tersenyum dan bersyukur.", source: "Bahagia - GAC" },
            { text: "Dan lapangkan dadamu, untuk terima itu. Agar senang hatimu, agar tenang jiwamu.", source: "Lapang Dada - Sheila On 7" },
            
            // WESTERN
            { text: "Lights will guide you home, and ignite your bones. And I will try to fix you.", source: "Fix You - Coldplay" },
            { text: "But I promise you this, I'll always look out for you.", source: "Sparks - Coldplay" },
            { text: "Just because you're losing, doesn't mean you're lost.", source: "Lost - Coldplay" },
            { text: "And you're gonna be happy. Turn this all around.", source: "Zero O'Clock - BTS" },
            { text: "You can't stop me lovin' myself.", source: "Idol - BTS" },
            { text: "Tak apa-apa jika kau kehabisan nafas, tidak ada yang menyalahkanmu.", source: "Breathe - Lee Hi" },
            { text: "It's okay not to be okay. It's okay not to be alright.", source: "OK Not To Be OK - Marshmello & Demi Lovato" },
            { text: "When you're down and out, remember everything will be okay.", source: "Be Alright - Dean Lewis" },
            { text: "There's a hope that's waiting for you in the dark.", source: "Scars to Your Beautiful - Alessia Cara" },
            { text: "You just gotta ignite the light, and let it shine.", source: "Firework - Katy Perry" },
            { text: "Here comes the sun, and I say, it's all right.", source: "Here Comes The Sun - The Beatles" }
        ],
        gratitude_prompts: [
            "Terima kasih sudah bertahan hari ini.", 
            "Capekmu valid, istirahatmu layak.",
            "Aku memaafkan diriku hari ini atas segala kekurangan.", 
            "Tubuhku, terima kasih sudah kuat menopangku seharian.",
            "Pikiran, terima kasih sudah bekerja keras, sekarang waktunya istirahat.",
            "Aku bersyukur untuk hal-hal kecil yang membuatku tersenyum hari ini.",
            "Terima kasih diriku, sudah mau mencoba lagi.",
            "Hari ini berat, tapi aku berhasil melewatinya.",
            "Aku bangga pada diriku sendiri sekecil apapun progresnya.",
            "Terima kasih nafas, terima kasih detak jantung."
        ],
        prayers: [
            // Doa Malam
            "Ya Tuhan, lindungilah tidurku dan bangunkan aku dalam keadaan lebih baik.",
            "Tuhan, terima kasih untuk hari ini. Aku serahkan esok hari ke dalam tangan-Mu.",
            "Semoga tidur ini menghapus lelah dan menyegarkan jiwa untuk esok.",
            "Ya Tuhan, tenangkanlah hatiku dari segala kecemasan yang berlebihan.",
            "Bismika Allahumma ahya wa amut. (Dengan nama-Mu Ya Allah aku hidup dan mati).",
            "Ya Allah, ampuni dosaku hari ini, sengaja maupun tidak. Izinkan aku tidur dengan hati bersih.",
            "Tuhan, jika hari ini aku terluka, sembuhkanlah dalam tidurku.",
            "Lindungi orang-orang yang kucintai saat mereka tidur malam ini."
        ],
        morning_prayers: [
            // Doa Pagi
            "Ya Allah, mudahkanlah urusanku dan lapangkanlah dadaku hari ini.",
            "Tuhan, berkahilah pagi ini dan jadikanlah pintu kebaikan terbuka untukku.",
            "Ya Allah, berilah aku kekuatan dan kesabaran untuk menjalani hari ini.",
            "Bismillahi tawakkaltu 'alallah. Aku berserah diri kepada-Mu untuk hari yang baru ini.",
            "Tuhan, jadikan hari ini lebih baik dari kemarin.",
            "Ya Allah, lindungilah aku dari hal-hal yang tidak baik hari ini.",
            "Semoga hari ini penuh dengan rezeki yang berkah dan hati yang tenang.",
            "Tuhan, bimbing langkahku agar selalu berada di jalan kebaikan."
        ],
        morning_encouragements: [
            "Semoga hari ini membawa kabar baik yang tak terduga untukmu!",
            "Apapun yang terjadi nanti, ingatlah kamu kuat dan mampu.",
            "Tarik napas, dunia menunggumu bersinar hari ini.",
            "Rezeki bukan cuma uang, tapi juga ketenangan hati. Semoga kamu mendapatkannya hari ini.",
            "Lakukan yang terbaik, sisanya biar Tuhan yang atur.",
            "Jangan lupa tersenyum pada diri sendiri di cermin pagi ini.",
            "Satu langkah kecil hari ini adalah kemajuan besar untuk masa depan.",
            "Kamu cukup. Kamu berharga. Kamu siap menghadapi hari ini.",
            "Fokus pada satu hal dalam satu waktu. Kamu pasti bisa.",
            "Hari ini adalah kesempatan baru untuk memperbaiki kesalahan kemarin."
        ],
        night_closings: [
            "Selamat tidur, orang baik. Besok kita mulai lagi.",
            "Lepaskan semua beban hari ini. Kamu pantas istirahat.",
            "Mimpi indah. Dunia akan baik-baik saja saat kamu tidur.",
            "Sampai jumpa besok pagi dengan semangat baru.",
            "Istirahatlah, pikiranmu juga butuh jeda.",
            "Malam adalah selimut untuk jiwamu yang lelah.",
            "Tutup matamu, biarkan damai menyelimutimu.",
            "Terima kasih sudah menjadi kuat hari ini. Selamat malam.",
            "Besok adalah misteri, tapi tidurmu malam ini adalah pasti. Nikmatilah.",
            "Segala urusan dunia bisa menunggu besok. Sekarang waktunya kamu."
        ],
        affirmations: [
            "Keberanian bukan berarti tidak takut, tapi terus berjalan meski takut.",
            "Energimu berharga, gunakan untuk hal yang menumbuhkanmu.",
            "Tidak apa-apa untuk memulai lagi dari awal.",
            "Kamu dicintai lebih dari yang kamu tahu.",
            "Hari ini penuh dengan kemungkinan baru.",
            "Tarik napas dalam-dalam, hembuskan keraguan.",
            "Langkah kecil juga merupakan kemajuan.",
            "Percayalah pada prosesmu sendiri.",
            "Kamu kuat, kamu mampu, kamu berharga.",
            "Dunia butuh cahaya yang hanya bisa kamu berikan.",
            "Izinkan dirimu untuk bahagia hari ini.",
            "Kesalahan adalah bukti kamu sedang mencoba.",
            "Fokus pada apa yang bisa kamu kendalikan.",
            "Tidak perlu sempurna untuk menjadi luar biasa.",
            "Kamu berhak untuk berkata 'tidak' demi kesehatan mentalmu.",
            "Masa lalumu tidak mendefinisikan masa depanmu.",
            "Setiap tantangan adalah kesempatan untuk tumbuh.",
            "Kamu layak mendapatkan kasih sayang, terutama dari dirimu sendiri.",
            "Kebahagiaan dimulai dari dalam diri sendiri.",
            "Hari ini aku memilih untuk bersikap lembut pada diriku."
        ],
        quran_quotes: [
            { text: "Maka sesungguhnya bersama kesulitan ada kemudahan.", surah: "QS. Al-Insyirah: 5" },
            { text: "Allah tidak membebani seseorang melainkan sesuai dengan kesanggupannya.", surah: "QS. Al-Baqarah: 286" },
            { text: "Dan Dia bersamamu di mana saja kamu berada.", surah: "QS. Al-Hadid: 4" },
            { text: "Ingatlah, hanya dengan mengingat Allah hati menjadi tenteram.", surah: "QS. Ar-Ra'd: 28" },
            { text: "Dan Tuhanmu berfirman: 'Berdoalah kepada-Ku, niscaya akan Kuperkenankan bagimu'.", surah: "QS. Ghafir: 60" },
            { text: "Dan bersabarlah, sesungguhnya Allah bersama orang-orang yang sabar.", surah: "QS. Al-Anfal: 46" },
            { text: "Cukuplah Allah menjadi Penolong kami dan Allah adalah sebaik-baik Pelindung.", surah: "QS. Ali Imran: 173" },
            { text: "Janganlah kamu bersikap lemah, dan janganlah (pula) kamu bersedih hati.", surah: "QS. Ali Imran: 139" },
            { text: "Dan Tuhanmu Maha Pemaaf lagi mempunyai kasih sayang.", surah: "QS. Al-Kahfi: 58" },
            { text: "Sesungguhnya Tuhanku benar-benar Maha Dekat lagi Maha Mengabulkan (doa) hamba-Nya.", surah: "QS. Hud: 61" },
            { text: "Maka bersabarlah kamu dengan sabar yang baik.", surah: "QS. Al-Ma'arij: 5" },
            { text: "Dan memberinya rezeki dari arah yang tiada disangka-sangkanya.", surah: "QS. At-Talaq: 3" },
            { text: "Maka nikmat Tuhan kamu yang manakah yang kamu dustakan?", surah: "QS. Ar-Rahman: 13" }
        ],
        defaultSpotify: {
            bloom: "https://open.spotify.com/embed/playlist/37i9dQZF1DX3rxVfibe1L0", 
            rest: "https://open.spotify.com/embed/playlist/5WPQ7cTY0btImTvJfzEF7X"  
        }
    };

    const MOODS = [
        { id: 'happy', emoji: 'üòÑ', label: 'Senang', color: 'var(--mood-happy)' },
        { id: 'calm', emoji: 'üòä', label: 'Tenang', color: 'var(--mood-calm)' },
        { id: 'neutral', emoji: 'üòê', label: 'Biasa', color: 'var(--mood-neutral)' },
        { id: 'sad', emoji: 'üòî', label: 'Sedih', color: 'var(--mood-sad)' },
        { id: 'heavy', emoji: 'üò≠', label: 'Berat', color: 'var(--mood-heavy)' },
        { id: 'angry', emoji: 'üò°', label: 'Marah', color: 'var(--mood-angry)' }
    ];

    /* =========================================
       STORAGE & UTILS
       ========================================= */
    const Storage = {
        KEY_JOURNAL: 'bloom_rest_data',
        KEY_PLANNER: 'bloom_rest_planner',
        KEY_SETTINGS: 'bloom_rest_settings',
        
        getJournal() { return JSON.parse(localStorage.getItem(this.KEY_JOURNAL)) || {}; },
        getPlanner() { 
            return JSON.parse(localStorage.getItem(this.KEY_PLANNER)) || [
                { id: 1, title: 'Prioritas Utama', tasks: [] },
                { id: 2, title: 'Personal', tasks: [] }
            ]; 
        },
        getSettings() { return JSON.parse(localStorage.getItem(this.KEY_SETTINGS)) || { spotify_bloom: "", spotify_rest: "" }; },

        getTodayKey() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        },

        saveJournal(dateKey, type, dataObj) {
            const allData = this.getJournal();
            if (!allData[dateKey]) allData[dateKey] = {};
            allData[dateKey][type] = { ...allData[dateKey][type], ...dataObj };
            localStorage.setItem(this.KEY_JOURNAL, JSON.stringify(allData));
        },

        savePlanner(data) { localStorage.setItem(this.KEY_PLANNER, JSON.stringify(data)); },
        saveSettings(data) { localStorage.setItem(this.KEY_SETTINGS, JSON.stringify(data)); },

        clear() {
            if(confirm("Hapus semua data (jurnal, tugas, pengaturan)?")) {
                localStorage.clear();
                location.reload();
            }
        }
    };

    const SpotifyHelper = {
        convertToEmbed(url) {
            if (!url) return null;
            if (url.includes('embed')) return url;
            try {
                const urlObj = new URL(url);
                const pathParts = urlObj.pathname.split('/').filter(p => p);
                if (pathParts.length >= 2) {
                    return `https://open.spotify.com/embed/${pathParts[0]}/${pathParts[1]}`;
                }
            } catch (e) { console.error("Invalid URL"); }
            return null;
        }
    };

    /* =========================================
       APP CONTROLLER
       ========================================= */
    const app = {
        state: {
            selectedMoodBloom: null,
            selectedMoodRest: null,
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
        },

        init() {
            this.router.init();
            this.renderMoodSelectors();
            this.setDailyLyric();
            this.setTodayDateDisplay();
            this.setGreeting();
            this.loadSpotify();
            this.planner.render(); 
            this.planner.renderPreviewHome();
        },

        setGreeting() {
            const hr = new Date().getHours();
            let greet = "Halo, Kamu.";
            if (hr < 11) greet = "Selamat Pagi ‚òÄÔ∏è";
            else if (hr < 15) greet = "Selamat Siang üå§Ô∏è";
            else if (hr < 18) greet = "Selamat Sore üå•Ô∏è";
            else greet = "Selamat Malam üåô";
            document.getElementById('greeting').innerText = greet;
        },

        setTodayDateDisplay() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('id-ID', options);
        },

        setDailyLyric() {
            const randomLyric = DATA.lyrics[Math.floor(Math.random() * DATA.lyrics.length)];
            document.getElementById('daily-lyric-text').innerText = `"${randomLyric.text}"`;
            document.getElementById('daily-lyric-source').innerText = randomLyric.source;
        },

        loadSpotify() {
            const settings = Storage.getSettings();
            const bloomUrl = settings.spotify_bloom || DATA.defaultSpotify.bloom;
            const restUrl = settings.spotify_rest || DATA.defaultSpotify.rest;

            document.getElementById('spotify-bloom').src = bloomUrl;
            document.getElementById('spotify-rest').src = restUrl;
            
            document.getElementById('setting-spotify-bloom').value = settings.spotify_bloom || "";
            document.getElementById('setting-spotify-rest').value = settings.spotify_rest || "";
        },

        renderMoodSelectors() {
            const render = (containerId, type) => {
                const container = document.getElementById(containerId);
                container.innerHTML = MOODS.map(m => `
                    <div class="mood-option" onclick="app.selectMood('${type}', '${m.id}', this)">
                        <span class="mood-emoji">${m.emoji}</span>
                        <span class="mood-label" style="font-size:0.7rem; color:var(--text-light)">${m.label}</span>
                    </div>
                `).join('');
            };
            render('bloom-moods', 'bloom');
            render('rest-moods', 'rest');
        },

        selectMood(type, moodId, el) {
            const container = el.parentElement;
            Array.from(container.children).forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            if (type === 'bloom') this.state.selectedMoodBloom = moodId;
            if (type === 'rest') this.state.selectedMoodRest = moodId;
        },

        /* --- MODULE: FORTUNE & QURAN --- */
        fortune: {
            isOpen: false, lastIndex: -1,
            open() {
                if (this.isOpen) return;
                const textEl = document.getElementById('fortune-text');
                const closedEl = document.getElementById('cookie-closed');
                const openedEl = document.getElementById('cookie-opened');
                let newIndex; do { newIndex = Math.floor(Math.random() * DATA.affirmations.length); } while (newIndex === this.lastIndex && DATA.affirmations.length > 1);
                this.lastIndex = newIndex; textEl.innerText = `"${DATA.affirmations[newIndex]}"`;
                closedEl.style.display = 'none'; openedEl.style.display = 'block'; this.isOpen = true;
            },
            reset() {
                document.getElementById('cookie-opened').style.display = 'none';
                document.getElementById('cookie-closed').style.display = 'block';
                this.isOpen = false;
            }
        },
        quran: {
            isOpen: false, lastIndex: -1,
            open() {
                if (this.isOpen) return;
                const textEl = document.getElementById('quran-text');
                const surahEl = document.getElementById('quran-surah');
                const closedEl = document.getElementById('quran-closed');
                const openedEl = document.getElementById('quran-opened');
                let newIndex; do { newIndex = Math.floor(Math.random() * DATA.quran_quotes.length); } while (newIndex === this.lastIndex && DATA.quran_quotes.length > 1);
                this.lastIndex = newIndex; const quote = DATA.quran_quotes[newIndex]; textEl.innerText = `"${quote.text}"`; surahEl.innerText = quote.surah;
                closedEl.style.display = 'none'; openedEl.style.display = 'block'; this.isOpen = true;
            },
            reset() {
                document.getElementById('quran-opened').style.display = 'none';
                document.getElementById('quran-closed').style.display = 'block';
                this.isOpen = false;
            }
        },

        /* --- MODULE: BLOOM (MORNING) --- */
        bloom: {
            save() {
                if (!app.state.selectedMoodBloom) { alert("Pilih mood kamu dulu ya üòä"); return; }
                const intention = document.getElementById('bloom-intention').value;
                const todos = Array.from(document.querySelectorAll('.todo-input')).map(i => i.value).filter(v => v.trim() !== "");
                Storage.saveJournal(Storage.getTodayKey(), 'bloom', { mood: app.state.selectedMoodBloom, intention, todos });
                
                // TRIGGER NEW MORNING FLOW
                app.overlay.startMorningFlow();
            }
        },

        /* --- MODULE: REST (NIGHT) --- */
        rest: {
            saveAndStartFlow() {
                if (!app.state.selectedMoodRest) { alert("Pilih mood malam dulu ya üåô"); return; }
                const recap = document.getElementById('rest-recap').value;
                const ref1 = document.getElementById('rest-ref1').value;
                const ref2 = document.getElementById('rest-ref2').value;
                const gratitude = document.getElementById('rest-gratitude').value;
                Storage.saveJournal(Storage.getTodayKey(), 'rest', { mood: app.state.selectedMoodRest, recap, reflections: [ref1, ref2], gratitude });
                
                // TRIGGER NIGHT FLOW
                app.overlay.startNightFlow();
            }
        },

        /* --- MODULE: PLANNER --- */
        planner: {
            data: [],
            load() { this.data = Storage.getPlanner(); },
            render() {
                this.load();
                const container = document.getElementById('planner-container');
                container.innerHTML = '';
                if (this.data.length === 0) container.innerHTML = '<p class="text-light text-center">Belum ada kategori. Buat baru yuk!</p>';
                this.data.forEach((cat, catIndex) => {
                    let tasksHtml = '';
                    cat.tasks.forEach((task, taskIndex) => {
                        tasksHtml += `<div class="task-item"><div class="task-check ${task.done?'checked':''}" onclick="app.planner.toggleTask(${catIndex},${taskIndex})"></div><span class="task-text ${task.done?'done':''}">${task.text}</span><i class="ph ph-trash delete-task" onclick="app.planner.deleteTask(${catIndex},${taskIndex})"></i></div>`;
                    });
                    container.innerHTML += `<div class="category-group"><div class="category-header"><span class="category-title">${cat.title}</span><i class="ph ph-trash" style="color:#ff7675; cursor:pointer;" onclick="app.planner.deleteCategory(${catIndex})"></i></div>${tasksHtml}<div style="display:flex; gap:5px; margin-top:5px;"><input type="text" id="new-task-${catIndex}" placeholder="+ Tambah tugas..." style="margin-bottom:0; font-size:0.9rem; padding:8px;" onkeypress="if(event.key==='Enter') app.planner.addTask(${catIndex})"><button class="btn-primary btn-icon" style="width:30px; height:30px;" onclick="app.planner.addTask(${catIndex})">+</button></div></div>`;
                });
            },
            renderPreviewHome() {
                this.load();
                const preview = document.getElementById('home-tasks-preview');
                let tasksToShow = [];
                this.data.forEach(cat => { cat.tasks.forEach(t => { if(!t.done) tasksToShow.push(t.text); }); });
                if(tasksToShow.length === 0) preview.innerHTML = `<p class="text-light text-xs">Semua tugas selesai! Santai sejenak.</p>`;
                else preview.innerHTML = tasksToShow.slice(0, 3).map(t => `<div style="display:flex; gap:8px; align-items:center; margin-bottom:4px;"><div style="width:6px; height:6px; background:var(--primary-dark); border-radius:50%;"></div><span class="text-xs">${t}</span></div>`).join('');
            },
            addCategoryPrompt() {
                const title = prompt("Nama Kategori Baru (misal: Belanja, Kerja):");
                if (title) { this.data.push({ id: Date.now(), title: title, tasks: [] }); Storage.savePlanner(this.data); this.render(); }
            },
            deleteCategory(index) {
                if(confirm("Hapus kategori ini dan semua tugasnya?")) { this.data.splice(index, 1); Storage.savePlanner(this.data); this.render(); }
            },
            addTask(catIndex) {
                const input = document.getElementById(`new-task-${catIndex}`); const text = input.value.trim();
                if (text) { this.data[catIndex].tasks.push({ text: text, done: false }); Storage.savePlanner(this.data); input.value = ''; this.render(); this.renderPreviewHome(); }
            },
            toggleTask(catIndex, taskIndex) {
                this.data[catIndex].tasks[taskIndex].done = !this.data[catIndex].tasks[taskIndex].done; Storage.savePlanner(this.data); this.render(); this.renderPreviewHome();
            },
            deleteTask(catIndex, taskIndex) {
                this.data[catIndex].tasks.splice(taskIndex, 1); Storage.savePlanner(this.data); this.render(); this.renderPreviewHome();
            }
        },

        /* --- MODULE: OVERLAY FLOW --- */
        overlay: {
            el: document.getElementById('gratitude-overlay'),
            title: document.getElementById('overlay-title'),
            text: document.getElementById('overlay-text'),
            icon: document.getElementById('overlay-icon'),
            actions: document.getElementById('overlay-actions'),

            // --- MORNING FLOW ---
            startMorningFlow() {
                this.el.classList.add('show');
                this.title.innerText = "Doa Pagi";
                this.icon.className = "ph-fill ph-sun-horizon";
                this.icon.style.color = "#FFB74D";
                this.text.innerText = `"${DATA.morning_prayers[Math.floor(Math.random() * DATA.morning_prayers.length)]}"`;
                
                this.actions.innerHTML = `
                    <button class="btn btn-primary" onclick="app.overlay.showMorningEncouragement()">Aamiin, Lanjut</button>
                `;
            },
            showMorningEncouragement() {
                this.title.innerText = "Semangat!";
                this.icon.className = "ph-fill ph-sparkle";
                this.icon.style.color = "#FFD54F";
                this.text.innerText = `"${DATA.morning_encouragements[Math.floor(Math.random() * DATA.morning_encouragements.length)]}"`;
                this.actions.innerHTML = `
                    <button class="btn btn-primary" onclick="app.overlay.finish()">Bismillah, Mulai Hari</button>
                `;
            },

            // --- NIGHT FLOW ---
            startNightFlow() {
                this.el.classList.add('show');
                this.title.innerText = "Terima Kasih Diriku";
                this.icon.className = "ph-fill ph-heart";
                this.icon.style.color = "#E57373";
                this.text.innerText = `"${DATA.gratitude_prompts[Math.floor(Math.random() * DATA.gratitude_prompts.length)]}"`;
                this.actions.innerHTML = `
                    <button class="btn btn-primary" onclick="app.overlay.showNightPrayer()">Lanjut ke Doa</button>
                    <button class="btn btn-outline" style="margin-top:10px" onclick="app.overlay.text.innerText='${DATA.gratitude_prompts[Math.floor(Math.random()*DATA.gratitude_prompts.length)]}'">Ganti Kalimat</button>
                `;
            },
            showNightPrayer() {
                this.title.innerText = "Doa Malam";
                this.icon.className = "ph-fill ph-moon-stars";
                this.icon.style.color = "#5C6BC0";
                this.text.innerText = DATA.prayers[Math.floor(Math.random() * DATA.prayers.length)];
                this.actions.innerHTML = `
                    <button class="btn btn-primary" onclick="app.overlay.showNightClosing()">Aamiin</button>
                `;
            },
            showNightClosing() {
                this.title.innerText = "Selamat Istirahat";
                this.icon.className = "ph-fill ph-bed";
                this.icon.style.color = "#9575CD";
                this.text.innerText = DATA.night_closings[Math.floor(Math.random() * DATA.night_closings.length)];
                this.actions.innerHTML = `
                    <button class="btn btn-primary" onclick="app.overlay.finish()">Tidur Nyenyak üí§</button>
                `;
            },

            finish() {
                this.el.classList.remove('show');
                app.router.go('calendar'); // Or home, or calendar as a summary
            }
        },

        /* --- MODULE: CALENDAR --- */
        calendar: {
            render() {
                const date = new Date(app.state.currentYear, app.state.currentMonth, 1);
                document.getElementById('cal-month-year').innerText = date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                const daysContainer = document.getElementById('calendar-days');
                daysContainer.innerHTML = '';
                
                const firstDayIndex = date.getDay(); 
                const daysInMonth = new Date(app.state.currentYear, app.state.currentMonth + 1, 0).getDate();

                for (let x = 0; x < firstDayIndex; x++) daysContainer.innerHTML += `<div class="calendar-day empty"></div>`;

                const allData = Storage.getJournal();
                const todayKey = Storage.getTodayKey();

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayKey = `${app.state.currentYear}-${String(app.state.currentMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const data = allData[dayKey];
                    let className = '';
                    let content = i;

                    if (data) {
                        const moodId = data.rest?.mood || data.bloom?.mood;
                        if (moodId) className = `day-${moodId}`;
                        if (data.bloom && data.rest) content += '<span style="position:absolute; bottom:-4px; right:0px; font-size:0.7rem;">üå∏</span>';
                    }
                    if (dayKey === todayKey) className += ' day-today';

                    daysContainer.innerHTML += `<div class="calendar-day ${className}" onclick="app.calendar.showDetail('${dayKey}')">${content}</div>`;
                }
            },
            prevMonth() { app.state.currentMonth--; if(app.state.currentMonth < 0) { app.state.currentMonth=11; app.state.currentYear--; } this.render(); },
            nextMonth() { app.state.currentMonth++; if(app.state.currentMonth > 11) { app.state.currentMonth=0; app.state.currentYear++; } this.render(); },
            
            showDetail(dateKey) {
                const data = Storage.getJournal()[dateKey];
                if (!data) return;
                const panel = document.getElementById('day-detail-panel');
                panel.style.display = 'block';
                document.getElementById('detail-date').innerText = dateKey;
                
                const getMoodLabel = (mid) => { const m = MOODS.find(x=>x.id===mid); return m ? `${m.emoji} ${m.label}` : '-'; };
                document.getElementById('detail-bloom-mood').innerText = getMoodLabel(data.bloom?.mood);
                document.getElementById('detail-intention').innerText = data.bloom?.intention || '-';
                document.getElementById('detail-rest-mood').innerText = getMoodLabel(data.rest?.mood);
                document.getElementById('detail-recap').innerText = data.rest?.recap || '-';
                document.getElementById('detail-gratitude').innerText = data.rest?.gratitude || '-';
            }
        },

        /* --- MODULE: SETTINGS --- */
        settings: {
            saveSpotify() {
                const bloom = document.getElementById('setting-spotify-bloom').value.trim();
                const rest = document.getElementById('setting-spotify-rest').value.trim();
                const bloomEmbed = SpotifyHelper.convertToEmbed(bloom);
                const restEmbed = SpotifyHelper.convertToEmbed(rest);
                const newData = { spotify_bloom: bloomEmbed || bloom, spotify_rest: restEmbed || rest };
                Storage.saveSettings(newData);
                app.loadSpotify();
                alert("Lagu berhasil disimpan! Cek menu Morning/Night.");
            }
        },

        /* --- MODULE: ROUTER --- */
        router: {
            init() {},
            go(viewId) {
                // Change View
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${viewId}`).classList.add('active');
                
                // Update Nav State
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navItem = document.querySelector(`.nav-item[data-target="${viewId}"]`);
                if(navItem) navItem.classList.add('active');

                // CHANGE THEME BASED ON ROUTE
                document.body.className = ''; // Reset theme
                if (viewId === 'bloom') document.body.classList.add('mode-bloom');
                if (viewId === 'rest') document.body.classList.add('mode-rest');
                
                // Load Special Components
                if (viewId === 'calendar') app.calendar.render();
                if (viewId === 'planner') app.planner.render();
                
                window.scrollTo(0,0);
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => { app.init(); });

</script>
</body>
</html>